{% extends 'sanatorium/doctors/snippets/base.html' %}
{% load static %}
{% block title %}Назначение медикаментов{% endblock %}
{% block extra_css %}
    <!-- Select2 -->
    <link rel="stylesheet" href="{% static 'adminlte3_assets/plugins/select2/css/select2.min.css' %}">
    <link rel="stylesheet"
          href="{% static 'adminlte3_assets/plugins/select2-bootstrap4-theme/select2-bootstrap4.min.css' %}">
    <!-- Tempusdominus Bootstrap 4 -->
    <link rel="stylesheet"
          href="{% static 'adminlte3_assets/plugins/tempusdominus-bootstrap-4/css/tempusdominus-bootstrap-4.min.css' %}">
    <!-- DataTables -->
    <link rel="stylesheet"
          href="{% static 'adminlte3_assets/plugins/datatables-bs4/css/dataTables.bootstrap4.min.css' %}">
    <link rel="stylesheet"
          href="{% static 'adminlte3_assets/plugins/datatables-responsive/css/responsive.bootstrap4.min.css' %}">
    <style>
        .form-group label {
            font-weight: bold;
        }

        .required-field::after {
            content: " *";
            color: red;
        }

        .nav-pills .nav-link.active {
            background-color: #007bff;
        }

        .tab-content {
            padding-top: 20px;
        }

        .selected-medication {
            padding: 8px 12px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            margin-top: 5px;
        }

        .selected-medication-info {
            font-size: 0.9rem;
            color: #6c757d;
            margin-top: 3px;
        }

        .modal-xl {
            max-width: 90%;
        }

        .filter-section {
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
            background-color: #f8f9fa;
        }

        .medication-details {
            cursor: pointer;
            color: #007bff;
        }

        .table-hover tbody tr:hover {
            background-color: rgba(0, 123, 255, 0.1);
            cursor: pointer;
        }

        .highlight {
            background-color: rgba(255, 193, 7, 0.2);
        }

        .selected-row {
            background-color: rgba(40, 167, 69, 0.2) !important;
        }
    </style>
{% endblock %}

{% block content %}
    <!-- Content Header (Page header) -->
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0">Назначение медикаментов</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="#">Главная</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'prescribed_medication_list' %}">Медикаменты</a>
                        </li>
                        <li class="breadcrumb-item active">Назначение медикаментов</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
    <!-- /.content-header -->

    <!-- Main content -->
    <section class="content">
        <div class="container-fluid">
            <!-- Success/Error Messages -->
            {% if messages %}
                <div class="row">
                    <div class="col-md-12">
                        {% for message in messages %}
                            <div class="alert alert-{% if message.tags == 'success' %}success{% else %}{{ message.tags }}{% endif %} alert-dismissible">
                                <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;
                                </button>
                                <h5>
                                    <i class="icon fas {% if message.tags == 'success' %}fa-check{% else %}fa-exclamation-triangle{% endif %}"></i> {{ message }}
                                </h5>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}

            <!-- Patient Information (If Available) -->
            {% if patient %}
                <div class="row">
                    <div class="col-md-12">
                        <div class="alert alert-info">
                            <h5><i class="icon fas fa-info"></i> Информация о пациенте</h5>
                            <div class="row">
                                <div class="col-md-4">
                                    <p><strong>ID пациента:</strong> {{ patient.id }}</p>
                                </div>
                                <div class="col-md-4">
                                    <p><strong>ФИО:</strong> {{ patient.full_name }}</p>
                                </div>
                                <div class="col-md-4">
                                    <p><strong>Дата рождения:</strong> {{ patient.date_of_birth }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}

            <!-- Form Card -->
            <div class="card card-primary">
                <div class="card-header">
                    <h3 class="card-title">Форма назначения медикаментов</h3>
                </div>
                <!-- /.card-header -->

                <!-- form start -->
                <form method="post" id="prescriptionForm">
                    {% csrf_token %}
                    <div class="card-body">
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                {{ form.non_field_errors }}
                            </div>
                        {% endif %}

                        <!-- Medication Selection -->
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="medication-search" class="required-field">Медикамент</label>
                                    <div class="input-group">
                                        <!-- Hidden input for actual form submission -->
                                        <input type="hidden" name="medication" id="selected-medication-id"
                                               value="{{ form.medication.value|default:'' }}">

                                        <!-- Button to open medication search modal -->
                                        <button type="button" class="btn btn-primary" id="medication-search-btn"
                                                data-toggle="modal" data-target="#medication-search-modal">
                                            <i class="fas fa-search"></i> Найти медикамент
                                        </button>
                                    </div>

                                    <!-- Display selected medication information -->
                                    <div id="selected-medication-container"
                                         class="selected-medication mt-2 {% if not form.medication.value %}d-none{% endif %}">
                                        <div id="selected-medication-name" class="font-weight-bold">
                                            {% if form.medication.value %}
                                                {{ selected_medication_name|default:"Выбранный медикамент" }}
                                            {% endif %}
                                        </div>
                                        <div id="selected-medication-info" class="selected-medication-info">
                                            {% if form.medication.value %}
                                                {{ selected_medication_info|default:"" }}
                                            {% endif %}
                                        </div>
                                    </div>

                                    {% if form.medication.errors %}
                                        <div class="text-danger">
                                            {{ form.medication.errors }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="{{ form.dosage.id_for_label }}" class="required-field">Дозировка</label>
                                    {{ form.dosage }}
                                    {% if form.dosage.errors %}
                                        <div class="text-danger">
                                            {{ form.dosage.errors }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="{{ form.route.id_for_label }}" class="required-field">Способ
                                        применения</label>
                                    {{ form.route }}
                                    {% if form.route.errors %}
                                        <div class="text-danger">
                                            {{ form.route.errors }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Schedule -->
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="{{ form.frequency.id_for_label }}" class="required-field">Частота
                                        приема</label>
                                    {{ form.frequency }}
                                    {% if form.frequency.errors %}
                                        <div class="text-danger">
                                            {{ form.frequency.errors }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="{{ form.start_date.id_for_label }}" class="required-field">Дата
                                        начала</label>
                                    <div class="input-group date" id="startDatePicker" data-target-input="nearest">
                                        {{ form.start_date }}
                                        <div class="input-group-append" data-target="#startDatePicker"
                                             data-toggle="datetimepicker">
                                            <div class="input-group-text"><i class="fa fa-calendar"></i></div>
                                        </div>
                                    </div>
                                    {% if form.start_date.errors %}
                                        <div class="text-danger">
                                            {{ form.start_date.errors }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="{{ form.end_date.id_for_label }}">Дата окончания</label>
                                    <div class="input-group date" id="endDatePicker" data-target-input="nearest">
                                        {{ form.end_date }}
                                        <div class="input-group-append" data-target="#endDatePicker"
                                             data-toggle="datetimepicker">
                                            <div class="input-group-text"><i class="fa fa-calendar"></i></div>
                                        </div>
                                    </div>
                                    {% if form.end_date.errors %}
                                        <div class="text-danger">
                                            {{ form.end_date.errors }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="{{ form.duration_days.id_for_label }}">Продолжительность (дней)</label>
                                    <div class="input-group">
                                        {{ form.duration_days }}
                                        <div class="input-group-append">
                                            <span class="input-group-text">дней</span>
                                        </div>
                                    </div>
                                    {% if form.duration_days.errors %}
                                        <div class="text-danger">
                                            {{ form.duration_days.errors }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Status and PRN -->
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="{{ form.status.id_for_label }}">Статус</label>
                                    {{ form.status }}
                                    {% if form.status.errors %}
                                        <div class="text-danger">
                                            {{ form.status.errors }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4 d-flex align-items-center">
                                <div class="form-group">
                                    <div class="custom-control custom-switch">
                                        {{ form.is_prn }}
                                        <label class="custom-control-label" for="{{ form.is_prn.id_for_label }}">
                                            По необходимости (PRN)
                                        </label>
                                    </div>
                                    {% if form.is_prn.errors %}
                                        <div class="text-danger">
                                            {{ form.is_prn.errors }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Instructions and Reason -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.instructions.id_for_label }}" class="required-field">Инструкции
                                        по применению</label>
                                    {{ form.instructions }}
                                    {% if form.instructions.errors %}
                                        <div class="text-danger">
                                            {{ form.instructions.errors }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.reason.id_for_label }}">Причина назначения</label>
                                    {{ form.reason }}
                                    {% if form.reason.errors %}
                                        <div class="text-danger">
                                            {{ form.reason.errors }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- /.card-body -->

                    <div class="card-footer">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Сохранить назначение
                        </button>
                        <a href="{% url 'prescribed_medication_list' %}" class="btn btn-default">
                            <i class="fas fa-arrow-left"></i> Назад
                        </a>
                    </div>
                </form>
            </div>
            <!-- /.card -->
        </div>
    </section>

    <!-- Medication Search Modal -->
    <div class="modal fade" id="medication-search-modal" tabindex="-1" role="dialog"
         aria-labelledby="medication-search-modal-label" aria-hidden="true">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header bg-primary">
                    <h5 class="modal-title" id="medication-search-modal-label">
                        <i class="fas fa-pills mr-2"></i>Поиск медикаментов
                    </h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- Filters Section -->
                    <div class="filter-section mb-3">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="search-term">Поиск по названию</label>
                                    <input type="text" class="form-control" id="search-term"
                                           placeholder="Введите часть названия...">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="category-filter">Категория</label>
                                    <select class="form-control select2" id="category-filter" style="width: 100%;">
                                        <option value="">Все категории</option>
                                        <option value="1">Антибиотики</option>
                                        <option value="2">Анальгетики</option>
                                        <option value="3">Противовоспалительные</option>
                                        <option value="4">Антигистаминные</option>
                                        <option value="5">Сердечно-сосудистые</option>
                                        <!-- Дополнительные категории... -->
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="stock-filter">Наличие</label>
                                    <select class="form-control" id="stock-filter">
                                        <option value="">Все</option>
                                        <option value="in-stock">В наличии</option>
                                        <option value="out-of-stock">Отсутствует</option>
                                        <option value="low-stock">Заканчивается</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label>&nbsp;</label>
                                    <button type="button" class="btn btn-primary btn-block" id="apply-filters">
                                        <i class="fas fa-filter mr-1"></i> Применить
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="active-ingredient-filter">Действующее вещество</label>
                                    <select class="form-control select2" id="active-ingredient-filter"
                                            style="width: 100%;">
                                        <option value="">Любое вещество</option>
                                        <option value="1">Парацетамол</option>
                                        <option value="2">Ибупрофен</option>
                                        <option value="3">Амоксициллин</option>
                                        <option value="4">Метформин</option>
                                        <!-- Дополнительные активные вещества... -->
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="form-filter">Форма выпуска</label>
                                    <select class="form-control select2" id="form-filter" style="width: 100%;">
                                        <option value="">Любая форма</option>
                                        <option value="1">Таблетки</option>
                                        <option value="2">Капсулы</option>
                                        <option value="3">Сироп</option>
                                        <option value="4">Инъекции</option>
                                        <option value="5">Мазь</option>
                                        <!-- Дополнительные формы выпуска... -->
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="manufacturer-filter">Производитель</label>
                                    <select class="form-control select2" id="manufacturer-filter" style="width: 100%;">
                                        <option value="">Любой производитель</option>
                                        <option value="1">Байер</option>
                                        <option value="2">Пфайзер</option>
                                        <option value="3">Новартис</option>
                                        <option value="4">Санофи</option>
                                        <!-- Дополнительные производители... -->
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>&nbsp;</label>
                                    <button type="button" class="btn btn-outline-secondary btn-block"
                                            id="reset-filters">
                                        <i class="fas fa-undo mr-1"></i> Сбросить фильтры
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Results Table -->
                    <div class="table-responsive">
                        <table id="medications-table" class="table table-bordered table-striped table-hover">
                            <thead>
                            <tr>
                                <th width="25%">Название</th>
                                <th width="15%">Форма выпуска</th>
                                <th width="15%">Активное вещество</th>
                                <th width="10%">Дозировка</th>
                                <th width="15%">Производитель</th>
                                <th width="10%">Наличие</th>
                                <th width="10%">Действия</th>
                            </tr>
                            </thead>
                            <tbody>
                            <!-- Данные будут загружены через AJAX -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" id="select-medication" disabled>
                        <i class="fas fa-check mr-1"></i> Выбрать медикамент
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Medication Details Modal -->
    <div class="modal fade" id="medication-details-modal" tabindex="-1" role="dialog"
         aria-labelledby="medication-details-modal-label" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header bg-info">
                    <h5 class="modal-title" id="medication-details-modal-label">
                        <i class="fas fa-info-circle mr-2"></i>Детальная информация о медикаменте
                    </h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="medication-details-content">
                        <!-- Содержимое будет загружено через AJAX -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>
                    <button type="button" class="btn btn-success" id="select-from-details">
                        <i class="fas fa-check mr-1"></i> Выбрать этот медикамент
                    </button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <!-- Select2 -->
    <script src="{% static 'adminlte3_assets/plugins/select2/js/select2.full.min.js' %}"></script>
    <!-- Moment.js -->
    <script src="{% static 'adminlte3_assets/plugins/moment/moment.min.js' %}"></script>
    <!-- Tempusdominus Bootstrap 4 -->
    <script src="{% static 'adminlte3_assets/plugins/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js' %}"></script>
    <!-- DataTables -->
    <script src="{% static 'adminlte3_assets/plugins/datatables/jquery.dataTables.min.js' %}"></script>
    <script src="{% static 'adminlte3_assets/plugins/datatables-bs4/js/dataTables.bootstrap4.min.js' %}"></script>
    <script src="{% static 'adminlte3_assets/plugins/datatables-responsive/js/dataTables.responsive.min.js' %}"></script>
    <script>
        $(function () {
            // Initialize Select2
            $('.select2').select2({
                theme: 'bootstrap4'
            });

            // Initialize date pickers
            $('#startDatePicker, #endDatePicker').datetimepicker({
                format: 'L',
                locale: 'ru',
                icons: {
                    time: 'far fa-clock',
                    date: 'far fa-calendar-alt',
                    up: 'fas fa-arrow-up',
                    down: 'fas fa-arrow-down',
                    previous: 'fas fa-chevron-left',
                    next: 'fas fa-chevron-right',
                    today: 'fas fa-calendar-check',
                    clear: 'far fa-trash-alt',
                    close: 'fas fa-times'
                }
            });

            // Auto-calculate duration when start and end dates change
            $('#startDatePicker, #endDatePicker').on('change.datetimepicker', function (e) {
                calculateDuration();
            });

            // Auto-calculate end date when duration changes
            $('#{{ form.duration_days.id_for_label }}').on('change', function () {
                calculateEndDate();
            });

            // Set PRN toggle behavior
            $('#{{ form.is_prn.id_for_label }}').on('change', function () {
                togglePRNFields();
            });

            // Initialize PRN fields state
            togglePRNFields();

            // Initialize medications DataTable
            var medicationsTable = $('#medications-table').DataTable({
                "processing": true,
                "serverSide": true,
                "ajax": {
                    "url": "",
                    "type": "POST",
                    "data": function (d) {
                        d.search_term = $('#search-term').val();
                        d.category = $('#category-filter').val();
                        d.stock_status = $('#stock-filter').val();
                        d.active_ingredient = $('#active-ingredient-filter').val();
                        d.form = $('#form-filter').val();
                        d.manufacturer = $('#manufacturer-filter').val();
                        d.csrfmiddlewaretoken = $('input[name=csrfmiddlewaretoken]').val();
                    }
                },
                "columns": [
                    {"data": "name"},
                    {"data": "form"},
                    {"data": "active_ingredient"},
                    {"data": "dosage"},
                    {"data": "manufacturer"},
                    {
                        "data": "stock_status",
                        "render": function (data, type, row) {
                            if (data === 'in-stock') {
                                return '<span class="badge badge-success">В наличии</span>';
                            } else if (data === 'low-stock') {
                                return '<span class="badge badge-warning">Заканчивается</span>';
                            } else {
                                return '<span class="badge badge-danger">Нет в наличии</span>';
                            }
                        }
                    },
                    {
                        "data": null,
                        "render": function (data, type, row) {
                            return '<button type="button" class="btn btn-info btn-sm view-details" data-id="' + row.id + '"><i class="fas fa-info-circle"></i></button>';
                        }
                    }
                ],
                "language": {
                    "url": "{% static 'adminlte3_assets/plugins/datatables/i18n/Russian.json' %}"
                },
                "responsive": true,
                "autoWidth": false,
                "pageLength": 10,
                "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "Все"]]
            });

            // Apply filters
            $('#apply-filters').on('click', function () {
                medicationsTable.ajax.reload();
            });

            // Reset filters
            $('#reset-filters').on('click', function () {
                $('#search-term').val('');
                $('#category-filter').val('').trigger('change.select2');
                $('#stock-filter').val('');
                $('#active-ingredient-filter').val('').trigger('change.select2');
                $('#form-filter').val('').trigger('change.select2');
                $('#manufacturer-filter').val('').trigger('change.select2');
                medicationsTable.ajax.reload();
            });

            // Handle row selection
            $('#medications-table tbody').on('click', 'tr', function () {
                // Toggle selection and highlight
                if ($(this).hasClass('selected-row')) {
                    $(this).removeClass('selected-row');
                    $('#select-medication').prop('disabled', true);
                } else {
                    $('#medications-table tbody tr').removeClass('selected-row');
                    $(this).addClass('selected-row');
                    $('#select-medication').prop('disabled', false);
                }
            });

            // Handle view details button
            $('#medications-table tbody').on('click', '.view-details', function (e) {
                e.stopPropagation(); // Prevent row selection

                var medicationId = $(this).data('id');

                // Load medication details via AJAX
                $.ajax({
                    url: "#",
                    type: "POST",
                    data: {
                        medication_id: medicationId,
                        csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                    },
                    success: function (response) {
                        // Populate details modal
                        $('#medication-details-content').html(response.html);
                        $('#select-from-details').data('id', medicationId);
                        $('#select-from-details').data('name', response.name);
                        $('#select-from-details').data('info', response.info);

                        // Show details modal
                        $('#medication-details-modal').modal('show');
                    },
                    error: function () {
                        toastr.error('Не удалось загрузить информацию о медикаменте');
                    }
                });
            });

            // Handle select from main table
            $('#select-medication').on('click', function () {
                var selectedRow = $('#medications-table tbody tr.selected-row');
                if (selectedRow.length) {
                    var rowData = medicationsTable.row(selectedRow).data();
                    selectMedication(rowData.id, rowData.name, rowData.form + ', ' + rowData.active_ingredient + ', ' + rowData.dosage);
                }
            });

            // Handle select from details
            $('#select-from-details').on('click', function () {
                var medicationId = $(this).data('id');
                var medicationName = $(this).data('name');
                var medicationInfo = $(this).data('info');

                selectMedication(medicationId, medicationName, medicationInfo);
                $('#medication-details-modal').modal('hide');
            });

            // Search on ENTER key in search field
            $('#search-term').on('keyup', function (e) {
                if (e.key === 'Enter') {
                    medicationsTable.ajax.reload();
                }
            });

            // Functions
            function calculateDuration() {
                var startDate = $('#startDatePicker').datetimepicker('date');
                var endDate = $('#endDatePicker').datetimepicker('date');

                if (startDate && endDate) {
                    var days = endDate.diff(startDate, 'days') + 1; // Including both start and end day
                    if (days > 0) {
                        $('#{{ form.duration_days.id_for_label }}').val(days);
                    }
                }
            }

            function calculateEndDate() {
                var startDate = $('#startDatePicker').datetimepicker('date');
                var duration = parseInt($('#{{ form.duration_days.id_for_label }}').val());

                if (startDate && !isNaN(duration) && duration > 0) {
                    var endDate = moment(startDate).add(duration - 1, 'days');
                    $('#endDatePicker').datetimepicker('date', endDate);
                }
            }

            function togglePRNFields() {
                var isPRN = $('#{{ form.is_prn.id_for_label }}').prop('checked');

                if (isPRN) {
                    // Hide frequency and duration fields
                    $('#{{ form.frequency.id_for_label }}').closest('.form-group').parent().slideUp();
                    $('#{{ form.duration_days.id_for_label }}').closest('.form-group').parent().slideUp();
                    $('#endDatePicker').closest('.form-group').parent().slideUp();
                } else {
                    // Show frequency and duration fields
                    $('#{{ form.frequency.id_for_label }}').closest('.form-group').parent().slideDown();
                    $('#{{ form.duration_days.id_for_label }}').closest('.form-group').parent().slideDown();
                    $('#endDatePicker').closest('.form-group').parent().slideDown();
                }
            }

            function selectMedication(id, name, info) {
                // Set the hidden input value
                $('#selected-medication-id').val(id);

                // Update the display
                $('#selected-medication-name').text(name);
                $('#selected-medication-info').text(info);
                $('#selected-medication-container').removeClass('d-none');

                // Close the modal
                $('#medication-search-modal').modal('hide');

                // Optional: Update the dosage field if available from medication
                if (typeof updateDosageField === 'function') {
                    updateDosageField(id);
                }
            }

            // Form validation
            $('#prescriptionForm').on('submit', function (e) {
                var isValid = true;

                // Find all required fields
                $(this).find('.required-field').each(function () {
                    var inputId = $(this).attr('for');

                    // Special case for medication which uses a hidden field
                    if (inputId === 'medication-search') {
                        if (!$('#selected-medication-id').val()) {
                            $(this).closest('.form-group').find('.text-danger').remove();
                            $(this).closest('.form-group').append('<div class="text-danger">Пожалуйста, выберите медикамент</div>');
                            isValid = false;
                        }
                        return;
                    }

                    var input = $('#' + inputId);

                    if (!input.val()) {
                        input.closest('.form-group').find('.text-danger').remove();
                        input.closest('.form-group').append('<div class="text-danger">Это поле обязательно для заполнения.</div>');
                        isValid = false;
                    }
                });

                if (!isValid) {
                    e.preventDefault();
                    return false;
                }
            });
        });
    </script>
{% endblock %}