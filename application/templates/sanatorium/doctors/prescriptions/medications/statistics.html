{% extends 'sanatorium/doctors/snippets/base.html' %}
{% load static %}

{% block title %}Medication Statistics - Hayat Medical Center{% endblock %}

{% block extra_css %}
<style>
    .stat-card {
        border-radius: 10px;
        border: none;
        box-shadow: 0 0 20px rgba(0,0,0,0.1);
        transition: transform 0.2s;
    }
    .stat-card:hover {
        transform: translateY(-2px);
    }
    .stat-number {
        font-size: 2rem;
        font-weight: bold;
    }
    .chart-container {
        position: relative;
        height: 400px;
        margin-bottom: 20px;
    }
    .compliance-bar {
        height: 20px;
        border-radius: 10px;
        background-color: #e9ecef;
        overflow: hidden;
    }
    .compliance-fill {
        height: 100%;
        transition: width 0.5s ease;
    }
    .date-filter-card {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
    }
    .medication-item {
        border-left: 4px solid #007bff;
        padding: 15px;
        margin-bottom: 10px;
        background-color: #f8f9fa;
    }
    .patient-compliance-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        border-bottom: 1px solid #dee2e6;
    }
</style>
{% endblock %}

{% block content %}
<!-- Content Header -->
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">
                    <i class="fas fa-chart-line"></i> Medication Statistics
                </h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="#">Home</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'medication_sessions_list' %}">Medications</a></li>
                    <li class="breadcrumb-item active">Statistics</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<!-- Main content -->
<section class="content">
    <div class="container-fluid">
        
        <!-- Date Filter -->
        <div class="card date-filter-card mb-4">
            <div class="card-body">
                <form method="get" id="date-filter-form">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="date_from">From Date:</label>
                                <input type="date" name="date_from" id="date_from" class="form-control" 
                                       value="{{ date_from|date:'Y-m-d' }}">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="date_to">To Date:</label>
                                <input type="date" name="date_to" id="date_to" class="form-control" 
                                       value="{{ date_to|date:'Y-m-d' }}">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>&nbsp;</label><br>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-filter"></i> Apply Filter
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="exportReport()">
                                    <i class="fas fa-download"></i> Export
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Overview Statistics -->
        <div class="row mb-4">
            <div class="col-lg-3 col-6">
                <div class="card stat-card bg-primary text-white">
                    <div class="card-body text-center">
                        <div class="stat-number">{{ total_sessions }}</div>
                        <p class="mb-0">Total Sessions</p>
                        <small>{{ date_from|date:"M d" }} - {{ date_to|date:"M d" }}</small>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-6">
                <div class="card stat-card bg-success text-white">
                    <div class="card-body text-center">
                        <div class="stat-number">{{ status_stats.administered }}</div>
                        <p class="mb-0">Administered</p>
                        <small>{{ compliance_rate }}% compliance</small>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-6">
                <div class="card stat-card bg-warning text-white">
                    <div class="card-body text-center">
                        <div class="stat-number">{{ status_stats.pending }}</div>
                        <p class="mb-0">Pending</p>
                        <small>Awaiting administration</small>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-6">
                <div class="card stat-card bg-danger text-white">
                    <div class="card-body text-center">
                        <div class="stat-number">{{ status_stats.missed }}</div>
                        <p class="mb-0">Missed</p>
                        <small>{{ status_stats.refused }} refused</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Charts Row -->
        <div class="row mb-4">
            <!-- Daily Compliance Chart -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-chart-area"></i> Daily Medication Compliance
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="dailyComplianceChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Status Distribution -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-chart-pie"></i> Status Distribution
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="statusPieChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Medication Usage Statistics -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-pills"></i> Top Medications
                        </h3>
                    </div>
                    <div class="card-body">
                        {% for medication in medication_stats %}
                        <div class="medication-item">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0">{{ medication.prescribed_medication__medication__item__name }}</h6>
                                <span class="badge badge-primary">{{ medication.total_sessions }} sessions</span>
                            </div>
                            <div class="row">
                                <div class="col-6">
                                    <small class="text-success">
                                        <i class="fas fa-check"></i> {{ medication.administered }} administered
                                    </small>
                                </div>
                                <div class="col-6">
                                    <small class="text-danger">
                                        <i class="fas fa-times"></i> {{ medication.missed }} missed
                                    </small>
                                </div>
                            </div>
                            <div class="compliance-bar mt-2">
                                {% widthratio medication.administered medication.total_sessions 100 as compliance_width %}
                                <div class="compliance-fill bg-success" style="width: {{ compliance_width }}%"></div>
                            </div>
                        </div>
                        {% empty %}
                        <p class="text-muted text-center">No medication data available for this period.</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <!-- Patient Compliance -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-users"></i> Patient Compliance
                        </h3>
                    </div>
                    <div class="card-body">
                        <div style="max-height: 400px; overflow-y: auto;">
                            {% for patient in patient_compliance %}
                            <div class="patient-compliance-item">
                                <div>
                                    <strong>{{ patient.prescribed_medication__illness_history__patient__f_name }} {{ patient.prescribed_medication__illness_history__patient__l_name }}</strong><br>
                                    <small class="text-muted">
                                        {{ patient.administered }}/{{ patient.total_sessions }} sessions
                                    </small>
                                </div>
                                <div class="text-right">
                                    <span class="badge 
                                        {% if patient.compliance_rate >= 90 %}badge-success
                                        {% elif patient.compliance_rate >= 70 %}badge-warning
                                        {% else %}badge-danger{% endif %}">
                                        {{ patient.compliance_rate|floatformat:0 }}%
                                    </span>
                                </div>
                            </div>
                            {% empty %}
                            <p class="text-muted text-center">No patient data available for this period.</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Summary Report -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-file-alt"></i> Summary Report
                </h3>
                <div class="card-tools">
                    <button class="btn btn-tool" onclick="printReport()">
                        <i class="fas fa-print"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5>Period: {{ date_from|date:"F d, Y" }} - {{ date_to|date:"F d, Y" }}</h5>
                        <ul class="list-unstyled">
                            <li><strong>Total Sessions:</strong> {{ total_sessions }}</li>
                            <li><strong>Successfully Administered:</strong> {{ status_stats.administered }} ({{ compliance_rate }}%)</li>
                            <li><strong>Missed Sessions:</strong> {{ status_stats.missed }}</li>
                            <li><strong>Refused Sessions:</strong> {{ status_stats.refused }}</li>
                            <li><strong>Pending Sessions:</strong> {{ status_stats.pending }}</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h5>Key Insights</h5>
                        <ul class="list-unstyled">
                            <li>
                                <i class="fas fa-arrow-{% if compliance_rate >= 80 %}up text-success{% else %}down text-danger{% endif %}"></i>
                                Compliance Rate: 
                                <span class="{% if compliance_rate >= 80 %}text-success{% else %}text-danger{% endif %}">
                                    {{ compliance_rate }}%
                                </span>
                            </li>
                            <li>
                                <i class="fas fa-pills text-primary"></i>
                                Most Used Medication: 
                                {% if medication_stats %}
                                    {{ medication_stats.0.prescribed_medication__medication__item__name }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </li>
                            <li>
                                <i class="fas fa-user text-info"></i>
                                Total Patients: {{ patient_compliance|length }}
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
$(document).ready(function() {
    // Daily Compliance Chart
    const dailyCtx = document.getElementById('dailyComplianceChart').getContext('2d');
    const dailyData = {{ daily_stats|safe }};
    
    new Chart(dailyCtx, {
        type: 'line',
        data: {
            labels: dailyData.map(item => item.date_display),
            datasets: [
                {
                    label: 'Administered',
                    data: dailyData.map(item => item.administered),
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    tension: 0.4
                },
                {
                    label: 'Missed',
                    data: dailyData.map(item => item.missed),
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    tension: 0.4
                },
                {
                    label: 'Total',
                    data: dailyData.map(item => item.total),
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            },
            plugins: {
                legend: {
                    position: 'top'
                },
                title: {
                    display: true,
                    text: 'Daily Medication Administration Trends'
                }
            }
        }
    });
    
    // Status Distribution Pie Chart
    const pieCtx = document.getElementById('statusPieChart').getContext('2d');
    const statusStats = {{ status_stats|safe }};
    
    new Chart(pieCtx, {
        type: 'doughnut',
        data: {
            labels: ['Administered', 'Pending', 'Missed', 'Refused', 'Canceled'],
            datasets: [{
                data: [
                    statusStats.administered,
                    statusStats.pending,
                    statusStats.missed,
                    statusStats.refused,
                    statusStats.canceled
                ],
                backgroundColor: [
                    '#28a745',
                    '#ffc107',
                    '#dc3545',
                    '#6c757d',
                    '#343a40'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                title: {
                    display: true,
                    text: 'Session Status Distribution'
                }
            }
        }
    });
    
    // Auto-submit form on date change
    $('#date_from, #date_to').change(function() {
        $('#date-filter-form').submit();
    });
});

function printReport() {
    window.print();
}

function exportReport() {
    // Implementation for exporting report to PDF/Excel
    alert('Export functionality to be implemented');
}

// Print styles
const printStyles = `
<style media="print">
    .card { break-inside: avoid; }
    .btn { display: none !important; }
    .chart-container { height: 300px !important; }
    @page { margin: 0.5in; }
    .no-print { display: none !important; }
</style>
`;
document.head.insertAdjacentHTML('beforeend', printStyles);
</script>
{% endblock %}