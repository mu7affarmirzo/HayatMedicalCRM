{% extends 'sanatorium/doctors/snippets/base.html' %}
{% load static %}

{% block title %}Питание - {{ patient.full_name }}{% endblock %}

{% block extra_css %}
    <!-- Select2 -->
    <link rel="stylesheet" href="{% static 'adminlte3_assets/plugins/select2/css/select2.min.css' %}">
    <link rel="stylesheet" href="{% static 'adminlte3_assets/plugins/select2-bootstrap4-theme/select2-bootstrap4.min.css' %}">
    <style>
        .diet-card {
            transition: transform 0.2s;
            cursor: pointer;
        }
        .diet-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .diet-status-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        .diet-type-icon {
            font-size: 2rem;
            margin-bottom: 1rem;
        }
        .nutrition-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 1.5rem;
        }
        .quick-actions {
            position: sticky;
            top: 20px;
            z-index: 100;
        }
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }
        .empty-state .icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
    </style>
{% endblock %}

{% block content %}
    <!-- Content Header (Page header) -->
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0">
                        <i class="fas fa-utensils text-primary mr-2"></i>
                        Питание пациента
                    </h1>
                    <p class="text-muted">{{ patient.full_name }} - {{ patient.date_of_birth|date:"d.m.Y" }}</p>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="{% url 'doctors_main_screen' %}">Главная</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'illness_history_detail' history.id %}">{{ patient.full_name }}</a></li>
                        <li class="breadcrumb-item active">Питание</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
    <!-- /.content-header -->

    <!-- Main content -->
    <section class="content">
        <div class="container-fluid">
            <!-- Success/Error Messages -->
            {% if messages %}
                <div class="row">
                    <div class="col-md-12">
                        {% for message in messages %}
                            <div class="alert alert-{% if message.tags == 'success' %}success{% elif message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible">
                                <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
                                <h5>
                                    <i class="icon fas {% if message.tags == 'success' %}fa-check{% else %}fa-exclamation-triangle{% endif %}"></i> 
                                    {{ message }}
                                </h5>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}

            <div class="row">
                <!-- Quick Actions Sidebar -->
                <div class="col-md-3">
                    <div class="quick-actions">
                        <div class="card card-primary">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <i class="fas fa-plus mr-2"></i>Быстрые действия
                                </h3>
                            </div>
                            <div class="card-body">
                                <a href="{% url 'diet_create' history.id %}" class="btn btn-primary btn-block mb-2">
                                    <i class="fas fa-plus mr-1"></i> Назначить диету
                                </a>
                                <button type="button" class="btn btn-info btn-block mb-2" data-toggle="modal" data-target="#quick-diet-modal">
                                    <i class="fas fa-bolt mr-1"></i> Быстрое назначение
                                </button>
                                <button type="button" class="btn btn-success btn-block mb-2" onclick="generateDietReport()">
                                    <i class="fas fa-file-pdf mr-1"></i> Отчет по питанию
                                </button>
                            </div>
                        </div>

                        <!-- Nutrition Summary -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <i class="fas fa-chart-pie mr-2"></i>Сводка питания
                                </h3>
                            </div>
                            <div class="card-body">
                                <div class="nutrition-info text-center">
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="h4 mb-0">1850</div>
                                            <div class="small">ккал/день</div>
                                        </div>
                                        <div class="col-6">
                                            <div class="h4 mb-0">5</div>
                                            <div class="small">приемов</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-3">
                                    <div class="d-flex justify-content-between">
                                        <span>Белки:</span>
                                        <span>85г (18%)</span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>Жиры:</span>
                                        <span>62г (30%)</span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>Углеводы:</span>
                                        <span>240г (52%)</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Content Area -->
                <div class="col-md-9">
                    <!-- Diet Tabs -->
                    <div class="card card-primary card-tabs">
                        <div class="card-header p-0 pt-1">
                            <ul class="nav nav-tabs" id="diet-tabs" role="tablist">
                                <li class="nav-item">
                                    <a class="nav-link active" id="active-tab" data-toggle="pill" href="#active" role="tab">
                                        <i class="fas fa-play mr-1"></i>Текущие диеты
                                        <span class="badge badge-light ml-1">2</span>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="completed-tab" data-toggle="pill" href="#completed" role="tab">
                                        <i class="fas fa-check mr-1"></i>Завершенные
                                        <span class="badge badge-light ml-1">3</span>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="recommendations-tab" data-toggle="pill" href="#recommendations" role="tab">
                                        <i class="fas fa-lightbulb mr-1"></i>Рекомендации
                                    </a>
                                </li>
                            </ul>
                        </div>
                        <div class="card-body">
                            <div class="tab-content" id="diet-tabsContent">
                                <!-- Active Diets Tab -->
                                <div class="tab-pane fade show active" id="active" role="tabpanel">
                                    <div class="row">
                                        <!-- Current Diet Card -->
                                        <div class="col-md-6 mb-3">
                                            <div class="card diet-card h-100" onclick="viewDietDetails(1)">
                                                <div class="card-body">
                                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                                        <div class="diet-type-icon text-success">
                                                            <i class="fas fa-heart"></i>
                                                        </div>
                                                        <span class="badge badge-success diet-status-badge">Активная</span>
                                                    </div>
                                                    <h5 class="card-title">Лечебная диета №10</h5>
                                                    <p class="card-text text-muted">
                                                        Диета при заболеваниях сердечно-сосудистой системы
                                                    </p>
                                                    <div class="row text-center mt-3">
                                                        <div class="col-4">
                                                            <div class="font-weight-bold">1800</div>
                                                            <div class="small text-muted">ккал</div>
                                                        </div>
                                                        <div class="col-4">
                                                            <div class="font-weight-bold">5</div>
                                                            <div class="small text-muted">приемов</div>
                                                        </div>
                                                        <div class="col-4">
                                                            <div class="font-weight-bold">7</div>
                                                            <div class="small text-muted">дней</div>
                                                        </div>
                                                    </div>
                                                    <div class="mt-3">
                                                        <div class="progress" style="height: 5px;">
                                                            <div class="progress-bar bg-success" role="progressbar" style="width: 60%"></div>
                                                        </div>
                                                        <small class="text-muted">60% выполнено</small>
                                                    </div>
                                                </div>
                                                <div class="card-footer">
                                                    <div class="btn-group btn-group-sm w-100" role="group">
                                                        <button type="button" class="btn btn-outline-primary" onclick="event.stopPropagation(); editDiet(1)">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-info" onclick="event.stopPropagation(); viewDietDetails(1)">
                                                            <i class="fas fa-eye"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-warning" onclick="event.stopPropagation(); copyDiet(1)">
                                                            <i class="fas fa-copy"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-danger" onclick="event.stopPropagation(); deleteDiet(1)">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Sample Diet Card 2 -->
                                        <div class="col-md-6 mb-3">
                                            <div class="card diet-card h-100" onclick="viewDietDetails(2)">
                                                <div class="card-body">
                                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                                        <div class="diet-type-icon text-primary">
                                                            <i class="fas fa-tint"></i>
                                                        </div>
                                                        <span class="badge badge-primary diet-status-badge">Активная</span>
                                                    </div>
                                                    <h5 class="card-title">Диета с низким содержанием соли</h5>
                                                    <p class="card-text text-muted">
                                                        Ограничение натрия до 2г в день
                                                    </p>
                                                    <div class="row text-center mt-3">
                                                        <div class="col-4">
                                                            <div class="font-weight-bold">1650</div>
                                                            <div class="small text-muted">ккал</div>
                                                        </div>
                                                        <div class="col-4">
                                                            <div class="font-weight-bold">4</div>
                                                            <div class="small text-muted">приемов</div>
                                                        </div>
                                                        <div class="col-4">
                                                            <div class="font-weight-bold">14</div>
                                                            <div class="small text-muted">дней</div>
                                                        </div>
                                                    </div>
                                                    <div class="mt-3">
                                                        <div class="progress" style="height: 5px;">
                                                            <div class="progress-bar bg-primary" role="progressbar" style="width: 30%"></div>
                                                        </div>
                                                        <small class="text-muted">30% выполнено</small>
                                                    </div>
                                                </div>
                                                <div class="card-footer">
                                                    <div class="btn-group btn-group-sm w-100" role="group">
                                                        <button type="button" class="btn btn-outline-primary" onclick="event.stopPropagation(); editDiet(2)">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-info" onclick="event.stopPropagation(); viewDietDetails(2)">
                                                            <i class="fas fa-eye"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-warning" onclick="event.stopPropagation(); copyDiet(2)">
                                                            <i class="fas fa-copy"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-danger" onclick="event.stopPropagation(); deleteDiet(2)">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Completed Diets Tab -->
                                <div class="tab-pane fade" id="completed" role="tabpanel">
                                    <div class="empty-state">
                                        <div class="icon">
                                            <i class="fas fa-check-circle"></i>
                                        </div>
                                        <h4>Завершенные диеты</h4>
                                        <p>Здесь будут отображаться завершенные диетические планы</p>
                                    </div>
                                </div>

                                <!-- Recommendations Tab -->
                                <div class="tab-pane fade" id="recommendations" role="tabpanel">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="callout callout-info">
                                                <h5><i class="fas fa-lightbulb"></i> Рекомендации по питанию</h5>
                                                <p>На основе анализа состояния пациента, рекомендуется:</p>
                                                <ul>
                                                    <li>Ограничить потребление соли до 2г в день</li>
                                                    <li>Увеличить потребление калия и магния</li>
                                                    <li>Исключить жареную и копченую пищу</li>
                                                    <li>Предпочтение отдавать запеченным и отварным блюдам</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Quick Diet Assignment Modal -->
    <div class="modal fade" id="quick-diet-modal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header bg-info">
                    <h5 class="modal-title">
                        <i class="fas fa-bolt mr-2"></i>Быстрое назначение диеты
                    </h5>
                    <button type="button" class="close text-white" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <form method="post" action="{% url 'diet_create' history.id %}">
                    {% csrf_token %}
                    <div class="modal-body">
                        <div class="form-group">
                            <label>Тип диеты</label>
                            <select name="diet_type" class="form-control" required>
                                <option value="">Выберите тип диеты</option>
                                <option value="standard">Стандартная диета</option>
                                <option value="therapeutic">Лечебная диета</option>
                                <option value="low_salt">Диета с низким содержанием соли</option>
                                <option value="diabetic">Диабетическая диета</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Примечания</label>
                            <textarea name="notes" class="form-control" rows="3" placeholder="Краткие примечания..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Отмена</button>
                        <button type="submit" class="btn btn-info">
                            <i class="fas fa-check mr-1"></i>Назначить
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="delete-diet-modal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header bg-danger">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle mr-2"></i>Подтверждение удаления
                    </h5>
                    <button type="button" class="close text-white" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Вы уверены, что хотите удалить эту диету?</p>
                    <p class="text-muted">Это действие нельзя отменить.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-danger" id="confirm-delete">
                        <i class="fas fa-trash mr-1"></i>Удалить
                    </button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <!-- Select2 -->
    <script src="{% static 'adminlte3_assets/plugins/select2/js/select2.full.min.js' %}"></script>
    <script>
        $(function() {
            // Initialize Select2
            $('.select2').select2({
                theme: 'bootstrap4'
            });

            // Initialize tabs
            $('#diet-tabs a').on('click', function (e) {
                e.preventDefault();
                $(this).tab('show');
            });
        });

        function viewDietDetails(dietId) {
            window.location.href = "{% url 'diet_detail' history.id 0 %}".replace('0', dietId);
        }

        function editDiet(dietId) {
            window.location.href = "{% url 'diet_update' history.id 0 %}".replace('0', dietId);
        }

        function copyDiet(dietId) {
            // Implement copy functionality
            alert('Функция копирования диеты будет реализована');
        }

        let dietToDelete = null;

        function deleteDiet(dietId) {
            dietToDelete = dietId;
            $('#delete-diet-modal').modal('show');
        }

        $('#confirm-delete').on('click', function() {
            if (dietToDelete) {
                // Create form and submit
                const form = $('<form>', {
                    'method': 'POST',
                    'action': "{% url 'diet_delete' history.id 0 %}".replace('0', dietToDelete)
                });
                form.append($('<input>', {
                    'type': 'hidden',
                    'name': 'csrfmiddlewaretoken',
                    'value': $('[name=csrfmiddlewaretoken]').val()
                }));
                $('body').append(form);
                form.submit();
            }
        });

        function generateDietReport() {
            // Implement report generation
            alert('Функция генерации отчета будет реализована');
        }
    </script>
{% endblock %}