{% extends 'warehouse/snippets/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Добавление товаров в перемещение на счет - Медицинский центр Хаят{% endblock %}

{% block content %}
<!-- Content Header (Page header) -->
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">Добавление товаров в перемещение</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="{% url 'warehouse:warehouse_dashboard' %}">Главная</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'warehouse:account_transfer_list' %}">Перемещения на счета</a></li>
                    <li class="breadcrumb-item active">Добавление товаров</li>
                </ol>
            </div>
        </div>
    </div>
</div>
<!-- /.content-header -->

<!-- Main content -->
<section class="content">
    <div class="container-fluid">
        <!-- Transfer Info -->
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Информация о перемещении</h3>
                        <div class="card-tools">
                            <a href="{% url 'warehouse:account_transfer_detail' transfer.id %}" class="btn btn-info btn-sm">
                                <i class="fas fa-eye"></i> Просмотр деталей
                            </a>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <table class="table table-bordered">
                                    <tr>
                                        <th style="width: 30%">Серийный номер</th>
                                        <td>{{ transfer.serial }}</td>
                                    </tr>
                                    <tr>
                                        <th>Склад-отправитель</th>
                                        <td>{{ transfer.sender.name }}</td>
                                    </tr>
                                    <tr>
                                        <th>Получатель</th>
                                        <td>{{ transfer.receiver.full_name }}</td>
                                    </tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <table class="table table-bordered">
                                    <tr>
                                        <th style="width: 30%">Статус</th>
                                        <td>
                                            <span class="badge badge-warning">{{ transfer.state }}</span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Период лечения</th>
                                        <td>{{ transfer.treatment_period|default:"Не указан" }}</td>
                                    </tr>
                                    <tr>
                                        <th>Ожидаемая дата возврата</th>
                                        <td>{{ transfer.expected_return_date|date:"d.m.Y"|default:"Не указана" }}</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Item Form -->
        <div class="row">
            <div class="col-md-12">
                <div class="card card-primary">
                    <div class="card-header">
                        <h3 class="card-title">Добавить товар в перемещение</h3>
                    </div>
                    <form method="post" action="">
                        {% csrf_token %}
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="item">Лекарство</label>
                                        <select class="form-control select2bs4" id="item" name="item" required>
                                            <option value="">Выберите лекарство</option>
                                            {% for medication in medications %}
                                                <option value="{{ medication.id }}">
                                                    {{ medication.name }} ({{ medication.in_pack }} шт. в упаковке)
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="batch">Партия</label>
                                        <select class="form-control select2bs4" id="batch" name="batch" required disabled>
                                            <option value="">Сначала выберите лекарство</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="quantity">Количество (упаковки)</label>
                                        <input type="number" class="form-control" id="quantity" name="quantity" min="0" value="0" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="unit_quantity">Количество (единицы)</label>
                                        <input type="number" class="form-control" id="unit_quantity" name="unit_quantity" min="0" value="0" required>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer">
                            <button type="submit" class="btn btn-primary">Добавить товар</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Current Items -->
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Товары в перемещении</h3>
                        <div class="card-tools">
                            <span class="badge badge-info">Общая сумма: {{ transfer.overall_sum|intcomma }}</span>
                        </div>
                    </div>
                    <div class="card-body table-responsive p-0">
                        <table class="table table-hover text-nowrap">
                            <thead>
                                <tr>
                                    <th>Наименование</th>
                                    <th>Партия</th>
                                    <th>Срок годности</th>
                                    <th>Количество (упаковки)</th>
                                    <th>Количество (единицы)</th>
                                    <th>Цена за единицу</th>
                                    <th>Общая сумма</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in transfer_items %}
                                <tr>
                                    <td>{{ item.item.item.name }}</td>
                                    <td>{{ item.income_seria }}</td>
                                    <td>{{ item.expire_date|date:"d.m.Y" }}</td>
                                    <td>{{ item.quantity }}</td>
                                    <td>{{ item.unit_quantity }}</td>
                                    <td>{{ item.unit_price|intcomma }}</td>
                                    <td>{{ item.overall_price|intcomma }}</td>
                                    <td>
                                        <a href="{% url 'warehouse:remove_account_transfer_item' transfer.id item.id %}" class="btn btn-danger btn-sm" onclick="return confirm('Вы уверены, что хотите удалить этот товар из перемещения?');">
                                            <i class="fas fa-trash"></i> Удалить
                                        </a>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="8" class="text-center">Товары не добавлены</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="card-footer">
                        <a href="{% url 'warehouse:account_transfer_detail' transfer.id %}" class="btn btn-success">
                            <i class="fas fa-check"></i> Завершить добавление товаров
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
    $(function() {
        // Initialize Select2 Elements
        $('.select2bs4').select2({
            theme: 'bootstrap4'
        });

        // Handle medication selection
        $('#item').on('change', function() {
            var medicationId = $(this).val();
            var warehouseId = '{{ transfer.sender.id }}';
            
            if (medicationId) {
                // Enable batch dropdown
                $('#batch').prop('disabled', false);
                
                // Clear previous options
                $('#batch').empty().append('<option value="">Загрузка партий...</option>');
                
                // Fetch batches via AJAX
                $.ajax({
                    url: '{% url "warehouse:get_account_medication_batches" %}',
                    data: {
                        'medication_id': medicationId,
                        'warehouse_id': warehouseId
                    },
                    dataType: 'json',
                    success: function(data) {
                        $('#batch').empty();
                        
                        if (data.results.length > 0) {
                            $.each(data.results, function(index, batch) {
                                $('#batch').append('<option value="' + batch.id + '" data-quantity="' + batch.quantity + '" data-unit-quantity="' + batch.unit_quantity + '">' + batch.text + '</option>');
                            });
                        } else {
                            $('#batch').append('<option value="">Нет доступных партий</option>');
                        }
                    },
                    error: function() {
                        $('#batch').empty().append('<option value="">Ошибка загрузки партий</option>');
                    }
                });
            } else {
                // Disable and reset batch dropdown
                $('#batch').prop('disabled', true);
                $('#batch').empty().append('<option value="">Сначала выберите лекарство</option>');
            }
        });

        // Handle batch selection
        $('#batch').on('change', function() {
            var selectedOption = $(this).find('option:selected');
            var availableQuantity = parseInt(selectedOption.data('quantity')) || 0;
            var availableUnitQuantity = parseInt(selectedOption.data('unit-quantity')) || 0;

            // Remove max attributes - validation will be done on total units
            $('#quantity').removeAttr('max');
            $('#unit_quantity').removeAttr('max');

            // Show available quantity to user
            if (selectedOption.val()) {
                $('#quantity').parent().find('label').html('Количество (упаковки) - доступно: ' + availableQuantity);
                $('#unit_quantity').parent().find('label').html('Количество (единицы) - доступно: ' + availableUnitQuantity);

                // Reset values
                $('#quantity').val(0);
                $('#unit_quantity').val(0);
            } else {
                $('#quantity').parent().find('label').html('Количество (упаковки)');
                $('#unit_quantity').parent().find('label').html('Количество (единицы)');
            }
        });

        // Form validation before submit
        $('form').on('submit', function(e) {
            var quantity = parseInt($('#quantity').val()) || 0;
            var unitQuantity = parseInt($('#unit_quantity').val()) || 0;

            // Note: Total units validation is done on the server side
            // This is just a basic check
            if (quantity === 0 && unitQuantity === 0) {
                e.preventDefault();
                alert('Пожалуйста, укажите количество упаковок или единиц.');
                return false;
            }
        });
    });
</script>
{% endblock %}