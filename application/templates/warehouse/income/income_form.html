{% extends 'warehouse/snippets/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}{% if is_update %}Редактирование{% else %}Создание{% endif %} поступления - Hayat Medical Center{% endblock %}

{% block extra_css %}
<!-- Select2 -->
<link rel="stylesheet" href="{% static 'adminlte3_assets/plugins/select2/css/select2.min.css' %}">
<link rel="stylesheet" href="{% static 'adminlte3_assets/plugins/select2-bootstrap4-theme/select2-bootstrap4.min.css' %}">
<!-- Tempusdominus Bootstrap 4 -->
<link rel="stylesheet" href="{% static 'adminlte3_assets/plugins/tempusdominus-bootstrap-4/css/tempusdominus-bootstrap-4.min.css' %}">
<style>
    .item-row {
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid #dee2e6;
    }
    .remove-item-btn {
        margin-top: 32px;
    }
    .add-item-btn {
        margin-top: 15px;
    }
</style>
{% endblock %}

{% block content %}
<!-- Content Header (Page header) -->
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">{% if is_update %}Редактирование{% else %}Создание{% endif %} поступления</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="{% url 'warehouse:warehouse_dashboard' %}">Главная</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'warehouse:income_list' %}">Список поступлений</a></li>
                    <li class="breadcrumb-item active">{% if is_update %}Редактирование{% else %}Создание{% endif %} поступления</li>
                </ol>
            </div>
        </div>
    </div>
</div>
<!-- /.content-header -->

<!-- Main content -->
<section class="content">
    <div class="container-fluid">
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible">
                    <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
                    <h5><i class="icon fas {% if message.tags == 'error' %}fa-ban{% elif message.tags == 'success' %}fa-check{% else %}fa-info{% endif %}"></i> {{ message }}</h5>
                </div>
            {% endfor %}
        {% endif %}

        <!-- Income Form Card -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">{% if is_update %}Редактирование{% else %}Создание{% endif %} поступления</h3>
            </div>
            <form method="post" id="income-form">
                {% csrf_token %}
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="receiver">Склад-получатель <span class="text-danger">*</span></label>
                                <select class="form-control select2bs4" name="receiver" id="receiver" required>
                                    <option value="">Выберите склад</option>
                                    {% for warehouse in warehouses %}
                                        <option value="{{ warehouse.id }}" {% if income and income.receiver.id == warehouse.id %}selected{% endif %}>{{ warehouse.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-5">
                            <div class="form-group">
                                <label for="delivery_company">Компания-поставщик</label>
                                <select class="form-control select2bs4" name="delivery_company" id="delivery_company">
                                    <option value="">Выберите компанию</option>
                                    {% for company in companies %}
                                        <option value="{{ company.id }}" {% if income and income.delivery_company and income.delivery_company.id == company.id %}selected{% endif %}>{{ company.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-1">
                            <div class="form-group">
                                <label>&nbsp;</label>
                                <button type="button" class="btn btn-success btn-block" data-toggle="modal" data-target="#addDeliveryCompanyModal" title="Добавить новую компанию">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="bill_amount">Сумма по счету</label>
                                <input type="number" class="form-control" name="bill_amount" id="bill_amount" value="{{ income.bill_amount|default:0 }}" min="0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="state">Статус</label>
                                <select class="form-control select2bs4" name="state" id="state">
                                    {% for state_code, state_name in state_choices %}
                                        <option value="{{ state_code }}" {% if income and income.state == state_code %}selected{% elif not income and state_code == 'принято' %}selected{% endif %}>{{ state_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    {% if is_update %}
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="serial">Серийный номер</label>
                                <input type="text" class="form-control" name="serial" id="serial" value="{{ income.serial }}" maxlength="255">
                                <small class="form-text text-muted">Изменение серийного номера обновит связанные записи в складских остатках</small>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    {% if not is_update %}
                    <hr>
                    <h4>Товары</h4>
                    <div id="items-container">
                        <div class="item-row" id="item-row-1">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label>Лекарство <span class="text-danger">*</span></label>
                                        <select class="form-control select2bs4 item-select" name="item_id" required>
                                            <option value="">Выберите лекарство</option>
                                            {% for medication in medications %}
                                                <option value="{{ medication.id }}">{{ medication.name }} ({{ medication.get_unit_display }})</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-1">
                                    <div class="form-group">
                                        <label>&nbsp;</label>
                                        <button type="button" class="btn btn-success btn-block" data-toggle="modal" data-target="#addMedicationModal" title="Добавить новое лекарство">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label>Количество (упаковок) <span class="text-danger">*</span></label>
                                        <input type="number" class="form-control" name="quantity" required min="1" value="1">
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label>Единиц в остатке</label>
                                        <input type="number" class="form-control" name="unit_quantity" min="0" value="0">
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label>Цена за упаковку</label>
                                        <input type="number" class="form-control" name="price" min="0" value="0">
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <button type="button" class="btn btn-danger remove-item-btn" onclick="removeItem(1)" style="display: none;"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label>Цена за единицу</label>
                                        <input type="number" class="form-control" name="unit_price" min="0" value="0">
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label>НДС (%)</label>
                                        <input type="number" class="form-control" name="nds" min="0" value="0">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label>Срок годности</label>
                                        <div class="input-group date" id="expire_date_1" data-target-input="nearest">
                                            <input type="text" class="form-control datetimepicker-input" data-target="#expire_date_1" name="expire_date">
                                            <div class="input-group-append" data-target="#expire_date_1" data-toggle="datetimepicker">
                                                <div class="input-group-text"><i class="fa fa-calendar"></i></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <button type="button" class="btn btn-success add-item-btn" id="add-item-btn"><i class="fas fa-plus"></i> Добавить товар</button>
                        </div>
                    </div>
                    {% endif %}
                </div>
                <div class="card-footer">
                    <button type="submit" class="btn btn-primary">Сохранить</button>
                    <a href="{% if income %}{% url 'warehouse:income_detail' income.id %}{% else %}{% url 'warehouse:income_list' %}{% endif %}" class="btn btn-default">Отмена</a>
                </div>
            </form>
        </div>

        <!-- Add Delivery Company Modal -->
        <div class="modal fade" id="addDeliveryCompanyModal" tabindex="-1" role="dialog" aria-labelledby="addDeliveryCompanyModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addDeliveryCompanyModalLabel">Добавить компанию-поставщика</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="addDeliveryCompanyForm">
                            {% csrf_token %}
                            <div class="form-group">
                                <label for="company_name">Название компании <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="company_name" name="name" required>
                            </div>
                            <div class="form-group">
                                <label for="contact_person">Контактное лицо</label>
                                <input type="text" class="form-control" id="contact_person" name="contact_person">
                            </div>
                            <div class="form-group">
                                <label for="phone_number">Телефон</label>
                                <input type="text" class="form-control" id="phone_number" name="phone_number">
                            </div>
                            <div class="form-group">
                                <label for="email">Email</label>
                                <input type="email" class="form-control" id="email" name="email">
                            </div>
                            <div class="form-group">
                                <label for="address">Адрес</label>
                                <textarea class="form-control" id="address" name="address" rows="2"></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Отмена</button>
                        <button type="button" class="btn btn-primary" id="saveDeliveryCompanyBtn">Сохранить</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Medication Modal -->
        <div class="modal fade" id="addMedicationModal" tabindex="-1" role="dialog" aria-labelledby="addMedicationModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addMedicationModalLabel">Добавить лекарство</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="addMedicationForm">
                            {% csrf_token %}
                            <div class="form-group">
                                <label for="medication_name">Название лекарства <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="medication_name" name="name" required>
                            </div>
                            <div class="form-group">
                                <label for="medication_company">Компания-производитель <span class="text-danger">*</span></label>
                                <select class="form-control" id="medication_company" name="company" required>
                                    <option value="">Выберите компанию</option>
                                    {% for company in manufacturer_companies %}
                                        <option value="{{ company.id }}">{{ company.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="in_pack">Количество в упаковке <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="in_pack" name="in_pack" value="10" min="1" required>
                            </div>
                            <div class="form-group">
                                <label for="unit">Единица измерения <span class="text-danger">*</span></label>
                                <select class="form-control" id="unit" name="unit" required>
                                    {% for unit_code, unit_name in medication_units %}
                                        <option value="{{ unit_code }}" {% if unit_code == 'tablet' %}selected{% endif %}>{{ unit_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Отмена</button>
                        <button type="button" class="btn btn-primary" id="saveMedicationBtn">Сохранить</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<!-- Select2 -->
<script src="{% static 'adminlte3_assets/plugins/select2/js/select2.full.min.js' %}"></script>
<!-- Moment.js -->
<script src="{% static 'adminlte3_assets/plugins/moment/moment.min.js' %}"></script>
<!-- Tempusdominus Bootstrap 4 -->
<script src="{% static 'adminlte3_assets/plugins/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js' %}"></script>

<script>
    $(function () {
        // Initialize Select2 Elements
        $('.select2bs4').select2({
            theme: 'bootstrap4'
        });

        // Initialize date picker
        $('.date').datetimepicker({
            format: 'YYYY-MM-DD',
            icons: {
                time: 'far fa-clock'
            }
        });
    });

    {% if not is_update %}
    // Item management
    let itemCount = 1;

    // Add new item row
    $('#add-item-btn').click(function() {
        itemCount++;
        const newRow = $('#item-row-1').clone();
        newRow.attr('id', 'item-row-' + itemCount);
        
        // Update IDs and clear values
        newRow.find('select, input').val('');
        newRow.find('select').attr('id', '').removeClass('select2-hidden-accessible');
        newRow.find('span.select2').remove();
        
        // Update date picker
        const datePicker = newRow.find('.date');
        datePicker.attr('id', 'expire_date_' + itemCount);
        datePicker.find('input').attr('data-target', '#expire_date_' + itemCount);
        datePicker.find('.input-group-append').attr('data-target', '#expire_date_' + itemCount);
        
        // Show remove button
        newRow.find('.remove-item-btn').attr('onclick', 'removeItem(' + itemCount + ')').show();
        
        // Append to container
        $('#items-container').append(newRow);
        
        // Reinitialize Select2 and date picker for the new row
        newRow.find('.select2bs4').select2({
            theme: 'bootstrap4'
        });
        
        newRow.find('.date').datetimepicker({
            format: 'YYYY-MM-DD',
            icons: {
                time: 'far fa-clock'
            }
        });
    });

    // Show remove button for first row if more than one item
    function updateRemoveButtons() {
        if ($('.item-row').length > 1) {
            $('.remove-item-btn').show();
        } else {
            $('.remove-item-btn').hide();
        }
    }

    // Remove item row
    function removeItem(id) {
        $('#item-row-' + id).remove();
        updateRemoveButtons();
    }
    {% endif %}

    // Add Delivery Company
    $('#saveDeliveryCompanyBtn').click(function() {
        const form = $('#addDeliveryCompanyForm');
        const formData = form.serialize();

        $.ajax({
            url: '{% url "warehouse:add_delivery_company" %}',
            type: 'POST',
            data: formData,
            success: function(response) {
                if (response.success) {
                    // Add new option to select
                    const newOption = new Option(response.company.name, response.company.id, true, true);
                    $('#delivery_company').append(newOption).trigger('change');

                    // Close modal and reset form
                    $('#addDeliveryCompanyModal').modal('hide');
                    form[0].reset();

                    // Show success message
                    alert('Компания успешно добавлена!');
                } else {
                    alert('Ошибка: ' + response.error);
                }
            },
            error: function(xhr, status, error) {
                alert('Ошибка при добавлении компании: ' + error);
            }
        });
    });

    // Add Medication
    $('#saveMedicationBtn').click(function() {
        const form = $('#addMedicationForm');
        const formData = form.serialize();

        $.ajax({
            url: '{% url "warehouse:add_medication" %}',
            type: 'POST',
            data: formData,
            success: function(response) {
                if (response.success) {
                    // Add new option to all medication selects
                    const displayText = response.medication.name + ' (' + response.medication.unit_display + ')';
                    $('.item-select').each(function() {
                        const newOption = new Option(displayText, response.medication.id, false, false);
                        $(this).append(newOption);
                    });

                    // Close modal and reset form
                    $('#addMedicationModal').modal('hide');
                    form[0].reset();

                    // Show success message
                    alert('Лекарство успешно добавлено!');
                } else {
                    alert('Ошибка: ' + response.error);
                }
            },
            error: function(xhr, status, error) {
                alert('Ошибка при добавлении лекарства: ' + error);
            }
        });
    });
</script>
{% endblock %}