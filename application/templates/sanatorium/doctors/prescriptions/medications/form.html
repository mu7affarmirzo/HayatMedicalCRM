{% extends 'sanatorium/doctors/snippets/base.html' %}
{% load static %}
{% block title %}Назначение медикаментов{% endblock %}
{% block extra_css %}
    <!-- Select2 -->
    <link rel="stylesheet" href="{% static 'adminlte3_assets/plugins/select2/css/select2.min.css' %}">
    <link rel="stylesheet" href="{% static 'adminlte3_assets/plugins/select2-bootstrap4-theme/select2-bootstrap4.min.css' %}">
    <!-- Tempusdominus Bootstrap 4 -->
    <link rel="stylesheet" href="{% static 'adminlte3_assets/plugins/tempusdominus-bootstrap-4/css/tempusdominus-bootstrap-4.min.css' %}">
    <style>
        .form-group label {
            font-weight: bold;
        }
        .required-field::after {
            content: " *";
            color: red;
        }
        .nav-pills .nav-link.active {
            background-color: #007bff;
        }
        .tab-content {
            padding-top: 20px;
        }
    </style>
{% endblock %}

{% block content %}
    <!-- Content Header (Page header) -->
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0">Назначение медикаментов</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="#">Главная</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'prescribed_medication_list' %}">Медикаменты</a></li>
                        <li class="breadcrumb-item active">Назначение медикаментов</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
    <!-- /.content-header -->

    <!-- Main content -->
    <section class="content">
        <div class="container-fluid">
            <!-- Success/Error Messages -->
            {% if messages %}
                <div class="row">
                    <div class="col-md-12">
                        {% for message in messages %}
                            <div class="alert alert-{% if message.tags == 'success' %}success{% else %}{{ message.tags }}{% endif %} alert-dismissible">
                                <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
                                <h5>
                                    <i class="icon fas {% if message.tags == 'success' %}fa-check{% else %}fa-exclamation-triangle{% endif %}"></i> {{ message }}
                                </h5>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}

            <!-- Patient Information (If Available) -->
            {% if patient %}
                <div class="row">
                    <div class="col-md-12">
                        <div class="alert alert-info">
                            <h5><i class="icon fas fa-info"></i> Информация о пациенте</h5>
                            <div class="row">
                                <div class="col-md-4">
                                    <p><strong>ID пациента:</strong> {{ patient.id }}</p>
                                </div>
                                <div class="col-md-4">
                                    <p><strong>ФИО:</strong> {{ patient.full_name }}</p>
                                </div>
                                <div class="col-md-4">
                                    <p><strong>Дата рождения:</strong> {{ patient.date_of_birth }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}

            <!-- Form Card -->
            <div class="card card-primary">
                <div class="card-header">
                    <h3 class="card-title">Форма назначения медикаментов</h3>
                </div>
                <!-- /.card-header -->

                <!-- form start -->
                <form method="post" id="prescriptionForm">
                    {% csrf_token %}
                    <div class="card-body">
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                {{ form.non_field_errors }}
                            </div>
                        {% endif %}

                        <!-- Medication Selection -->
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="{{ form.medication.id_for_label }}" class="required-field">Медикамент</label>
                                    {{ form.medication }}
                                    {% if form.medication.errors %}
                                        <div class="text-danger">
                                            {{ form.medication.errors }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="{{ form.dosage.id_for_label }}" class="required-field">Дозировка</label>
                                    {{ form.dosage }}
                                    {% if form.dosage.errors %}
                                        <div class="text-danger">
                                            {{ form.dosage.errors }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="{{ form.route.id_for_label }}">Способ применения</label>
                                    {{ form.route }}
                                    {% if form.route.errors %}
                                        <div class="text-danger">
                                            {{ form.route.errors }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Schedule -->
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="{{ form.frequency.id_for_label }}" class="required-field">Частота приема</label>
                                    {{ form.frequency }}
                                    {% if form.frequency.errors %}
                                        <div class="text-danger">
                                            {{ form.frequency.errors }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="{{ form.start_date.id_for_label }}" class="required-field">Дата начала</label>
                                    <div class="input-group date" id="startDatePicker" data-target-input="nearest">
                                        {{ form.start_date }}
                                        <div class="input-group-append" data-target="#startDatePicker" data-toggle="datetimepicker">
                                            <div class="input-group-text"><i class="fa fa-calendar"></i></div>
                                        </div>
                                    </div>
                                    {% if form.start_date.errors %}
                                        <div class="text-danger">
                                            {{ form.start_date.errors }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="{{ form.end_date.id_for_label }}">Дата окончания</label>
                                    <div class="input-group date" id="endDatePicker" data-target-input="nearest">
                                        {{ form.end_date }}
                                        <div class="input-group-append" data-target="#endDatePicker" data-toggle="datetimepicker">
                                            <div class="input-group-text"><i class="fa fa-calendar"></i></div>
                                        </div>
                                    </div>
                                    {% if form.end_date.errors %}
                                        <div class="text-danger">
                                            {{ form.end_date.errors }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="{{ form.duration_days.id_for_label }}">Продолжительность (дней)</label>
                                    <div class="input-group">
                                        {{ form.duration_days }}
                                        <div class="input-group-append">
                                            <span class="input-group-text">дней</span>
                                        </div>
                                    </div>
                                    {% if form.duration_days.errors %}
                                        <div class="text-danger">
                                            {{ form.duration_days.errors }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Status and PRN -->
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="{{ form.status.id_for_label }}">Статус</label>
                                    {{ form.status }}
                                    {% if form.status.errors %}
                                        <div class="text-danger">
                                            {{ form.status.errors }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4 d-flex align-items-center">
                                <div class="form-group">
                                    <div class="custom-control custom-switch">
                                        {{ form.is_prn }}
                                        <label class="custom-control-label" for="{{ form.is_prn.id_for_label }}">
                                            По необходимости (PRN)
                                        </label>
                                    </div>
                                    {% if form.is_prn.errors %}
                                        <div class="text-danger">
                                            {{ form.is_prn.errors }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Instructions and Reason -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.instructions.id_for_label }}" class="required-field">Инструкции по применению</label>
                                    {{ form.instructions }}
                                    {% if form.instructions.errors %}
                                        <div class="text-danger">
                                            {{ form.instructions.errors }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.reason.id_for_label }}">Причина назначения</label>
                                    {{ form.reason }}
                                    {% if form.reason.errors %}
                                        <div class="text-danger">
                                            {{ form.reason.errors }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- /.card-body -->

                    <div class="card-footer">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Сохранить назначение
                        </button>
                        <a href="{% url 'prescribed_medication_list' %}" class="btn btn-default">
                            <i class="fas fa-arrow-left"></i> Назад
                        </a>
                    </div>
                </form>
            </div>
            <!-- /.card -->
        </div>
    </section>
{% endblock %}

{% block extra_js %}
    <!-- Select2 -->
    <script src="{% static 'adminlte3_assets/plugins/select2/js/select2.full.min.js' %}"></script>
    <!-- Moment.js -->
    <script src="{% static 'adminlte3_assets/plugins/moment/moment.min.js' %}"></script>
    <!-- Tempusdominus Bootstrap 4 -->
    <script src="{% static 'adminlte3_assets/plugins/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js' %}"></script>
    <script>
        $(function() {
            // Initialize Select2
            $('.select2').select2({
                theme: 'bootstrap4'
            });

            // Initialize date pickers
            $('#startDatePicker, #endDatePicker').datetimepicker({
                format: 'L',
                locale: 'ru',
                icons: {
                    time: 'far fa-clock',
                    date: 'far fa-calendar-alt',
                    up: 'fas fa-arrow-up',
                    down: 'fas fa-arrow-down',
                    previous: 'fas fa-chevron-left',
                    next: 'fas fa-chevron-right',
                    today: 'fas fa-calendar-check',
                    clear: 'far fa-trash-alt',
                    close: 'fas fa-times'
                }
            });

            // Auto-calculate duration when start and end dates change
            $('#startDatePicker, #endDatePicker').on('change.datetimepicker', function(e) {
                calculateDuration();
            });

            // Auto-calculate end date when duration changes
            $('#{{ form.duration_days.id_for_label }}').on('change', function() {
                calculateEndDate();
            });

            // Set PRN toggle behavior
            $('#{{ form.is_prn.id_for_label }}').on('change', function() {
                togglePRNFields();
            });

            // Initialize PRN fields state
            togglePRNFields();

            // Functions
            function calculateDuration() {
                var startDate = $('#startDatePicker').datetimepicker('date');
                var endDate = $('#endDatePicker').datetimepicker('date');

                if (startDate && endDate) {
                    var days = endDate.diff(startDate, 'days') + 1; // Including both start and end day
                    if (days > 0) {
                        $('#{{ form.duration_days.id_for_label }}').val(days);
                    }
                }
            }

            function calculateEndDate() {
                var startDate = $('#startDatePicker').datetimepicker('date');
                var duration = parseInt($('#{{ form.duration_days.id_for_label }}').val());

                if (startDate && !isNaN(duration) && duration > 0) {
                    var endDate = moment(startDate).add(duration - 1, 'days');
                    $('#endDatePicker').datetimepicker('date', endDate);
                }
            }

            function togglePRNFields() {
                var isPRN = $('#{{ form.is_prn.id_for_label }}').prop('checked');

                if (isPRN) {
                    // Hide frequency and duration fields
                    $('#{{ form.frequency.id_for_label }}').closest('.form-group').parent().slideUp();
                    $('#{{ form.duration_days.id_for_label }}').closest('.form-group').parent().slideUp();
                    $('#endDatePicker').closest('.form-group').parent().slideUp();
                } else {
                    // Show frequency and duration fields
                    $('#{{ form.frequency.id_for_label }}').closest('.form-group').parent().slideDown();
                    $('#{{ form.duration_days.id_for_label }}').closest('.form-group').parent().slideDown();
                    $('#endDatePicker').closest('.form-group').parent().slideDown();
                }
            }

            // Form validation
            $('#prescriptionForm').on('submit', function(e) {
                var isValid = true;

                // Find all required fields
                $(this).find('.required-field').each(function() {
                    var inputId = $(this).attr('for');
                    var input = $('#' + inputId);

                    if (!input.val()) {
                        input.closest('.form-group').find('.text-danger').remove();
                        input.closest('.form-group').append('<div class="text-danger">Это поле обязательно для заполнения.</div>');
                        isValid = false;
                    }
                });

                if (!isValid) {
                    e.preventDefault();
                    return false;
                }
            });
        });
    </script>
{% endblock %}