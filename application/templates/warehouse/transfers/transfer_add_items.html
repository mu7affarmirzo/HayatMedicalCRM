{% extends 'warehouse/snippets/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Добавление товаров в перемещение - Медицинский центр Хаят{% endblock %}

{% block extra_css %}
<style>
    .item-row {
        margin-bottom: 15px;
        padding: 10px;
        border-radius: 5px;
        background-color: #f8f9fa;
    }
    .item-row:hover {
        background-color: #e9ecef;
    }
</style>
{% endblock %}

{% block content %}
<!-- Content Header (Page header) -->
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">Добавление товаров в перемещение</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="{% url 'warehouse:warehouse_dashboard' %}">Главная</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'warehouse:transfer_list' %}">Перемещения</a></li>
                    <li class="breadcrumb-item active">Добавление товаров</li>
                </ol>
            </div>
        </div>
    </div>
</div>
<!-- /.content-header -->

<!-- Main content -->
<section class="content">
    <div class="container-fluid">
        <!-- Transfer Info -->
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Информация о перемещении</h3>
                        <div class="card-tools">
                            <a href="{% url 'warehouse:transfer_detail' transfer.id %}" class="btn btn-info btn-sm">
                                <i class="fas fa-eye"></i> Просмотр деталей
                            </a>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <table class="table table-bordered">
                                    <tr>
                                        <th style="width: 30%">Серийный номер</th>
                                        <td>{{ transfer.serial }}</td>
                                    </tr>
                                    <tr>
                                        <th>Склад-отправитель</th>
                                        <td>{{ transfer.sender.name }}</td>
                                    </tr>
                                    <tr>
                                        <th>Склад-получатель</th>
                                        <td>{{ transfer.receiver.name }}</td>
                                    </tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <table class="table table-bordered">
                                    <tr>
                                        <th style="width: 30%">Статус</th>
                                        <td>
                                            <span class="badge badge-warning">{{ transfer.state }}</span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Дата создания</th>
                                        <td>{{ transfer.created_at|date:"d.m.Y H:i" }}</td>
                                    </tr>
                                    <tr>
                                        <th>Общая сумма</th>
                                        <td>{{ transfer.overall_sum|intcomma }}</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Item Form -->
        <div class="row">
            <div class="col-md-12">
                <div class="card card-primary">
                    <div class="card-header">
                        <h3 class="card-title">Добавить товар в перемещение</h3>
                    </div>
                    <form method="post" action="{% url 'warehouse:transfer_add_items' transfer.id %}">
                        {% csrf_token %}
                        <div class="card-body">
                            {% if messages %}
                                {% for message in messages %}
                                    <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible">
                                        <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
                                        {{ message }}
                                    </div>
                                {% endfor %}
                            {% endif %}

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="item">Лекарство</label>
                                        <select class="form-control select2bs4" id="item" name="item" required>
                                            <option value="">-- Выберите лекарство --</option>
                                            {% for medication in medications %}
                                                <option value="{{ medication.id }}">
                                                    {{ medication.name }} ({{ medication.company.name }})
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="batch">Партия</label>
                                        <select class="form-control select2bs4" id="batch" name="batch" required disabled>
                                            <option value="">-- Сначала выберите лекарство --</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="quantity">Количество (упаковок)</label>
                                        <input type="number" class="form-control" id="quantity" name="quantity" min="0" value="0" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="unit_quantity">Количество (единиц)</label>
                                        <input type="number" class="form-control" id="unit_quantity" name="unit_quantity" min="0" value="0">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer">
                            <button type="submit" class="btn btn-primary">Добавить товар</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Current Items -->
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Товары в перемещении</h3>
                        <div class="card-tools">
                            <a href="{% url 'warehouse:transfer_detail' transfer.id %}" class="btn btn-success btn-sm">
                                <i class="fas fa-check"></i> Завершить добавление
                            </a>
                        </div>
                    </div>
                    <div class="card-body table-responsive p-0">
                        <table class="table table-hover text-nowrap">
                            <thead>
                                <tr>
                                    <th>Лекарство</th>
                                    <th>Партия</th>
                                    <th>Срок годности</th>
                                    <th>Количество (упаковок)</th>
                                    <th>Количество (единиц)</th>
                                    <th>Цена за единицу</th>
                                    <th>Общая сумма</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in transfer_items %}
                                <tr>
                                    <td>{{ item.item.item.name }}</td>
                                    <td>{{ item.income_seria }}</td>
                                    <td>{{ item.expire_date|date:"d.m.Y" }}</td>
                                    <td>{{ item.quantity }}</td>
                                    <td>{{ item.unit_quantity }}</td>
                                    <td>{{ item.unit_price|intcomma }}</td>
                                    <td>{{ item.overall_price|intcomma }}</td>
                                    <td>
                                        <a href="{% url 'warehouse:remove_transfer_item' transfer.id item.id %}" class="btn btn-danger btn-sm" onclick="return confirm('Вы уверены, что хотите удалить этот товар из перемещения?');">
                                            <i class="fas fa-trash"></i> Удалить
                                        </a>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="8" class="text-center">Товары не добавлены</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <th colspan="6" class="text-right">Итого:</th>
                                    <th>{{ transfer.overall_sum|intcomma }}</th>
                                    <th></th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
    $(function() {
        // Initialize Select2 Elements
        $('.select2bs4').select2({
            theme: 'bootstrap4'
        });

        // Load batches when medication is selected
        $('#item').on('change', function() {
            var medicationId = $(this).val();
            var warehouseId = '{{ transfer.sender.id }}';
            
            if (medicationId) {
                // Enable batch select
                $('#batch').prop('disabled', false);
                
                // Clear current options
                $('#batch').empty().append('<option value="">-- Загрузка партий... --</option>');
                
                // Load batches via AJAX
                $.ajax({
                    url: '{% url "warehouse:get_medication_batches" %}',
                    data: {
                        'medication_id': medicationId,
                        'warehouse_id': warehouseId
                    },
                    dataType: 'json',
                    success: function(data) {
                        $('#batch').empty().append('<option value="">-- Выберите партию --</option>');
                        
                        if (data.results && data.results.length > 0) {
                            $.each(data.results, function(index, batch) {
                                $('#batch').append('<option value="' + batch.id + '" data-quantity="' + batch.quantity + '" data-unit-quantity="' + batch.unit_quantity + '">' + batch.text + '</option>');
                            });
                        } else {
                            $('#batch').append('<option value="">Нет доступных партий</option>');
                        }
                        
                        $('#batch').trigger('change');
                    },
                    error: function() {
                        $('#batch').empty().append('<option value="">Ошибка загрузки партий</option>');
                    }
                });
            } else {
                // Disable and reset batch select
                $('#batch').prop('disabled', true);
                $('#batch').empty().append('<option value="">-- Сначала выберите лекарство --</option>');
            }
        });

        // Update max quantity when batch is selected
        $('#batch').on('change', function() {
            var selectedOption = $(this).find('option:selected');
            var maxQuantity = selectedOption.data('quantity') || 0;
            var maxUnitQuantity = selectedOption.data('unit-quantity') || 0;
            
            $('#quantity').attr('max', maxQuantity);
            $('#unit_quantity').attr('max', maxUnitQuantity);
            
            // Reset quantity inputs if they exceed the max
            if (parseInt($('#quantity').val()) > maxQuantity) {
                $('#quantity').val(maxQuantity);
            }
            
            if (parseInt($('#unit_quantity').val()) > maxUnitQuantity) {
                $('#unit_quantity').val(maxUnitQuantity);
            }
        });
    });
</script>
{% endblock %}