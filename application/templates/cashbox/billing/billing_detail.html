{% extends 'cashbox/snippets/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Детали счета - Бронирование #{{ booking.booking_number }} - Hayat Medical Center{% endblock %}

{% block content %}
<!-- Content Header (Page header) -->
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">Детали счета</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="{% url 'cashbox:billing_list' %}">Счета</a></li>
                    <li class="breadcrumb-item active">{{ booking.booking_number }}</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<!-- Main content -->
<section class="content">
    <div class="container-fluid">
        
        <!-- Booking Info Card -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-info-circle"></i> Информация о бронировании #{{ booking.booking_number }}
                </h3>
                <div class="card-tools">
                    <span class="badge badge-lg badge-{{ booking.status_display_color }}">
                        {{ booking.get_status_display }}
                    </span>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <strong>Период пребывания:</strong><br>
                        {{ booking.start_date|date:"d.m.Y H:i" }} - {{ booking.end_date|date:"d.m.Y H:i" }}<br>
                        <small class="text-muted">Продолжительность: {{ stay_duration }} дней</small>
                    </div>
                    <div class="col-md-6">
                        <strong>Персонал:</strong><br>
                        {{ booking.staff.get_full_name|default:"Не указан" }}
                    </div>
                </div>
                
                {% if booking.notes %}
                <div class="row mt-3">
                    <div class="col-12">
                        <strong>Примечания:</strong><br>
                        {{ booking.notes }}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Patients and Rooms -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-users"></i> Пациенты и размещение
                </h3>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Пациент</th>
                                <th>Комната</th>
                                <th>Тариф</th>
                                <th>Стоимость</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for detail in booking_details %}
                            <tr>
                                <td>
                                    <strong>{{ detail.client.full_name }}</strong><br>
                                    <small class="text-muted">{{ detail.client.phone|default:"Телефон не указан" }}</small>
                                </td>
                                <td>
                                    {{ detail.room.name }}<br>
                                    <small class="text-muted">{{ detail.room.room_type.name }}</small>
                                </td>
                                <td>
                                    {{ detail.tariff.name }}<br>
                                    <small class="text-muted">{{ detail.tariff.description|truncatewords:10 }}</small>
                                </td>
                                <td>
                                    <span class="billing-amount">{{ detail.price|intcomma }} сум</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Detailed Per-Patient Breakdown -->
        {% if patient_breakdowns %}
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-user-md"></i> Детальная разбивка по пациентам
                </h3>
            </div>
            <div class="card-body">
                {% for breakdown in patient_breakdowns %}
                <div class="patient-breakdown-section mb-4 p-3 border rounded">
                    <h4 class="text-primary">
                        <i class="fas fa-user"></i> {{ breakdown.patient.full_name }}
                    </h4>
                    <p class="text-muted">
                        <i class="fas fa-door-open"></i> {{ breakdown.room.name }} ({{ breakdown.room.room_type.name }}) |
                        <i class="fas fa-tag"></i> {{ breakdown.tariff.name }}
                    </p>

                    <!-- Tariff Base -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="card card-outline card-primary">
                                <div class="card-header">
                                    <h5 class="card-title"><i class="fas fa-file-invoice"></i> Базовый тариф</h5>
                                </div>
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <span>{{ breakdown.tariff.name }}</span>
                                        <strong class="text-primary">{{ breakdown.tariff_base_price|intcomma }} сум</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Services Breakdown -->
                    {% if breakdown.services.included %}
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="card card-outline card-info">
                                <div class="card-header">
                                    <h5 class="card-title"><i class="fas fa-spa"></i> Услуги в тарифе</h5>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm table-hover">
                                        <thead>
                                            <tr>
                                                <th>Услуга</th>
                                                <th class="text-center">Включено</th>
                                                <th class="text-center">Использовано</th>
                                                <th class="text-center">Превышение</th>
                                                <th class="text-right">Стоимость</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for svc in breakdown.services.included %}
                                            <tr {% if svc.exceeded > 0 %}class="table-warning"{% endif %}>
                                                <td>{{ svc.service.name }}</td>
                                                <td class="text-center">{{ svc.included }}</td>
                                                <td class="text-center">
                                                    {% if svc.used > svc.included %}
                                                        <span class="badge badge-warning">{{ svc.used }}</span>
                                                    {% else %}
                                                        {{ svc.used }}
                                                    {% endif %}
                                                </td>
                                                <td class="text-center">
                                                    {% if svc.exceeded > 0 %}
                                                        <span class="badge badge-danger">+{{ svc.exceeded }}</span>
                                                    {% else %}
                                                        <span class="text-muted">—</span>
                                                    {% endif %}
                                                </td>
                                                <td class="text-right">
                                                    {% if svc.exceeded > 0 %}
                                                        <span class="text-success">Включено</span>
                                                    {% else %}
                                                        <span class="text-success">Включено</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Extra Services (Charged) -->
                    {% if breakdown.services.extra %}
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="card card-outline card-warning">
                                <div class="card-header">
                                    <h5 class="card-title"><i class="fas fa-exclamation-triangle"></i> Дополнительные услуги (оплачиваются)</h5>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Услуга</th>
                                                <th class="text-center">Количество</th>
                                                <th class="text-right">Цена за сеанс</th>
                                                <th class="text-right">Стоимость</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for svc in breakdown.services.extra %}
                                            <tr>
                                                <td>{{ svc.service.name }}</td>
                                                <td class="text-center">{{ svc.exceeded }}</td>
                                                <td class="text-right">{{ svc.unit_price|intcomma }} сум</td>
                                                <td class="text-right"><strong class="text-warning">{{ svc.total_cost|intcomma }} сум</strong></td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                        <tfoot>
                                            <tr class="table-warning">
                                                <td colspan="3" class="text-right"><strong>Итого доп. услуги:</strong></td>
                                                <td class="text-right"><strong>{{ breakdown.totals.services_extra|intcomma }} сум</strong></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Medications -->
                    {% if breakdown.medications %}
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="card card-outline card-success">
                                <div class="card-header">
                                    <h5 class="card-title"><i class="fas fa-pills"></i> Медикаменты</h5>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Название</th>
                                                <th class="text-center">Количество</th>
                                                <th class="text-right">Цена за единицу</th>
                                                <th class="text-right">Стоимость</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for med in breakdown.medications %}
                                            <tr>
                                                <!-- <td>{{ med.medication.item.name }}</td> -->
                                                <td>{{ med.medication.income_seria }}</td>
                                                <td class="text-center">{{ med.quantity }}</td>
                                                <td class="text-right">{{ med.unit_price|intcomma }} сум</td>
                                                <td class="text-right"><strong>{{ med.total_cost|intcomma }} сум</strong></td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                        <tfoot>
                                            <tr class="table-success">
                                                <td colspan="3" class="text-right"><strong>Итого медикаменты:</strong></td>
                                                <td class="text-right"><strong>{{ breakdown.totals.medications|intcomma }} сум</strong></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Lab Tests -->
                    {% if breakdown.labs %}
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="card card-outline card-secondary">
                                <div class="card-header">
                                    <h5 class="card-title"><i class="fas fa-vials"></i> Лабораторные исследования</h5>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Исследование</th>
                                                <th class="text-center">Статус</th>
                                                <th class="text-right">Стоимость</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for lab in breakdown.labs %}
                                            <tr {% if not lab.is_billable %}class="table-light"{% endif %}>
                                                <td>{{ lab.lab.name }}</td>
                                                <td class="text-center">
                                                    <span class="badge badge-{% if lab.is_billable %}success{% else %}secondary{% endif %}">
                                                        {{ lab.state }}
                                                    </span>
                                                </td>
                                                <td class="text-right">
                                                    {% if lab.is_billable %}
                                                        <strong>{{ lab.price|intcomma }} сум</strong>
                                                    {% else %}
                                                        <span class="text-muted">не оплачивается</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                        {% if breakdown.totals.labs > 0 %}
                                        <tfoot>
                                            <tr class="table-secondary">
                                                <td colspan="2" class="text-right"><strong>Итого анализы:</strong></td>
                                                <td class="text-right"><strong>{{ breakdown.totals.labs|intcomma }} сум</strong></td>
                                            </tr>
                                        </tfoot>
                                        {% endif %}
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Procedures -->
                    {% if breakdown.procedures %}
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="card card-outline card-info">
                                <div class="card-header">
                                    <h5 class="card-title"><i class="fas fa-procedures"></i> Процедуры</h5>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Процедура</th>
                                                <th class="text-right">Стоимость</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for proc in breakdown.procedures %}
                                            <tr>
                                                <td>{{ proc.procedure.name }}</td>
                                                <td class="text-right">
                                                    {% if proc.is_billable %}
                                                        <strong>{{ proc.price|intcomma }} сум</strong>
                                                    {% else %}
                                                        <span class="text-muted">включено</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                        {% if breakdown.totals.procedures > 0 %}
                                        <tfoot>
                                            <tr class="table-info">
                                                <td class="text-right"><strong>Итого процедуры:</strong></td>
                                                <td class="text-right"><strong>{{ breakdown.totals.procedures|intcomma }} сум</strong></td>
                                            </tr>
                                        </tfoot>
                                        {% endif %}
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Patient Subtotal -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card card-primary">
                                <div class="card-body">
                                    <h5 class="mb-3">Итого по пациенту:</h5>
                                    <table class="table table-sm mb-0">
                                        <tr>
                                            <td>Базовый тариф:</td>
                                            <td class="text-right">{{ breakdown.totals.tariff_base|intcomma }} сум</td>
                                        </tr>
                                        {% if breakdown.totals.services_extra > 0 %}
                                        <tr>
                                            <td>Доп. услуги:</td>
                                            <td class="text-right text-warning"><strong>{{ breakdown.totals.services_extra|intcomma }} сум</strong></td>
                                        </tr>
                                        {% endif %}
                                        {% if breakdown.totals.medications > 0 %}
                                        <tr>
                                            <td>Медикаменты:</td>
                                            <td class="text-right">{{ breakdown.totals.medications|intcomma }} сум</td>
                                        </tr>
                                        {% endif %}
                                        {% if breakdown.totals.labs > 0 %}
                                        <tr>
                                            <td>Анализы:</td>
                                            <td class="text-right">{{ breakdown.totals.labs|intcomma }} сум</td>
                                        </tr>
                                        {% endif %}
                                        {% if breakdown.totals.procedures > 0 %}
                                        <tr>
                                            <td>Процедуры:</td>
                                            <td class="text-right">{{ breakdown.totals.procedures|intcomma }} сум</td>
                                        </tr>
                                        {% endif %}
                                        <tr class="table-primary">
                                            <td><strong>ИТОГО ПО ПАЦИЕНТУ:</strong></td>
                                            <td class="text-right"><strong class="h5">{{ breakdown.totals.subtotal|intcomma }} сум</strong></td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% if not forloop.last %}<hr>{% endif %}
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Billing Summary -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-calculator"></i> Общий расчет стоимости
                </h3>
                <div class="card-tools">
                    {% if 'calculate_billing' in available_actions %}
                    <form method="post" style="display: inline;">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="calculate_billing">
                        <button type="submit" class="btn btn-warning btn-sm">
                            <i class="fas fa-calculator"></i> Пересчитать
                        </button>
                    </form>
                    {% endif %}

                    {% if 'mark_invoiced' in available_actions %}
                    <form method="post" style="display: inline;">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="mark_invoiced">
                        <button type="submit" class="btn btn-primary btn-sm">
                            <i class="fas fa-file-invoice"></i> Выставить счет
                        </button>
                    </form>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="billing-breakdown">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card card-outline card-primary">
                                        <div class="card-header">
                                            <h3 class="card-title">Базовый тариф</h3>
                                        </div>
                                        <div class="card-body">
                                            <h4 class="text-primary">{{ billing_breakdown.tariff_base|intcomma }} сум</h4>
                                            <p class="text-muted">Стоимость согласно тарифному плану</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card card-outline card-warning">
                                        <div class="card-header">
                                            <h3 class="card-title">Доп. услуги</h3>
                                        </div>
                                        <div class="card-body">
                                            <h4 class="text-warning">{{ billing_breakdown.additional_services|intcomma }} сум</h4>
                                            <p class="text-muted">Услуги сверх тарифа</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card card-outline card-info">
                                        <div class="card-header">
                                            <h3 class="card-title">Медикаменты</h3>
                                        </div>
                                        <div class="card-body">
                                            <h4 class="text-info">{{ billing_breakdown.medications|intcomma }} сум</h4>
                                            <p class="text-muted">Прописанные лекарства</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card card-outline card-secondary">
                                        <div class="card-header">
                                            <h3 class="card-title">Лабораторные</h3>
                                        </div>
                                        <div class="card-body">
                                            <h4 class="text-secondary">{{ billing_breakdown.lab_research|intcomma }} сум</h4>
                                            <p class="text-muted">Анализы и исследования</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card card-outline card-success">
                            <div class="card-header">
                                <h3 class="card-title">Итого к оплате</h3>
                            </div>
                            <div class="card-body text-center">
                                <h2 class="billing-total">{{ billing_breakdown.grand_total_from_patients|intcomma }} сум</h2>
                                <p class="text-muted small mb-1">
                                    <i class="fas fa-info-circle"></i> Сумма всех пациентов
                                </p>
                                <p class="text-muted">
                                    Статус:
                                    <span class="badge badge-{% if billing.billing_status == 'pending' %}warning{% elif billing.billing_status == 'calculated' %}success{% else %}primary{% endif %}">
                                        {{ billing.get_billing_status_display }}
                                    </span>
                                </p>
                                {% if billing.billing_status == 'calculated' %}
                                <button class="btn btn-success btn-lg btn-block">
                                    <i class="fas fa-credit-card"></i> Принять оплату
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Additional Services Details -->
        {% if additional_services %}
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-plus-circle"></i> Дополнительные услуги
                </h3>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Пациент</th>
                                <th>Услуга</th>
                                <th>Количество</th>
                                <th>Дата</th>
                                <th>Стоимость</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for service in additional_services %}
                            <tr>
                                <td>{{ service.booking_detail.client.full_name }}</td>
                                <td>{{ service.service.name }}</td>
                                <td>{{ service.quantity }}</td>
                                <td>{{ service.date_used|date:"d.m.Y" }}</td>
                                <td>{{ service.price|intcomma }} сум</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Prescribed Medications -->
        {% if prescribed_medications %}
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-pills"></i> Прописанные медикаменты
                </h3>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Пациент</th>
                                <th>Медикамент</th>
                                <th>Количество</th>
                                <th>Дата</th>
                                <th>Стоимость</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for med in prescribed_medications %}
                            <tr>
                                <td>{{ med.prescribed_medication.illness_history.patient.full_name }}</td>
                                <td>{{ med.prescribed_medication.medication.name }}</td>
                                <td>{{ med.quantity }}</td>
                                <td>{{ med.session_date|date:"d.m.Y" }}</td>
                                <td>
                                    {% if med.prescribed_medication.medication.unit_price %}
                                        {{ med.total_cost|intcomma }} сум
                                    {% else %}
                                        <span class="text-muted">Не указана</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Lab Tests -->
        {% if lab_tests %}
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-vials"></i> Лабораторные исследования
                </h3>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Пациент</th>
                                <th>Исследование</th>
                                <th>Дата назначения</th>
                                <th>Статус</th>
                                <th>Стоимость</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for lab in lab_tests %}
                            <tr>
                                <td>{{ lab.illness_history.patient.full_name }}</td>
                                <td>{{ lab.lab_research.name }}</td>
                                <td>{{ lab.assigned_date|date:"d.m.Y" }}</td>
                                <td>
                                    <span class="badge badge-{% if lab.status == 'completed' %}success{% elif lab.status == 'in_progress' %}warning{% else %}secondary{% endif %}">
                                        {{ lab.get_status_display }}
                                    </span>
                                </td>
                                <td>
                                    {% if lab.lab_research.price %}
                                        {{ lab.lab_research.price|intcomma }} сум
                                    {% else %}
                                        <span class="text-muted">Не указана</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Procedures -->
        {% if procedures %}
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-procedures"></i> Процедуры
                </h3>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Пациент</th>
                                <th>Процедура</th>
                                <th>Дата</th>
                                <th>Статус</th>
                                <th>Стоимость</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for procedure in procedures %}
                            <tr>
                                <td>{{ procedure.prescribed_procedure.illness_history.patient.full_name }}</td>
                                <td>{{ procedure.prescribed_procedure.service.name }}</td>
                                <td>{{ procedure.session_date|date:"d.m.Y" }}</td>
                                <td>
                                    <span class="badge badge-{% if procedure.status == 'completed' %}success{% elif procedure.status == 'in_progress' %}warning{% else %}secondary{% endif %}">
                                        {{ procedure.get_status_display }}
                                    </span>
                                </td>
                                <td>
                                    {% if procedure.prescribed_procedure.service.base_price %}
                                        {{ procedure.prescribed_procedure.service.base_price|intcomma }} сум
                                    {% else %}
                                        <span class="text-muted">Не указана</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
// Custom template filter simulation for multiplication
$(document).ready(function() {
    // Any additional JavaScript for the billing detail page
});
</script>
{% endblock %}