{% extends "logus/snippets/base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Бронирование #{{ booking.booking_number }} - Hayat Medical Center{% endblock %}

{% block content %}
    <!-- Content Header (Page header) -->
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0">
                        Бронирование #{{ booking.booking_number }}
                        <span class="badge badge-{{ status_badge_class }}">{{ booking.get_status_display }}</span>
                    </h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="#">Главная</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'logus:booking_list' %}">Бронирования</a></li>
                        <li class="breadcrumb-item active">{{ booking.booking_number }}</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
    <!-- /.content-header -->

    <!-- Main content -->
    <section class="content">
        <div class="container-fluid">
            {% if messages %}
                <div class="row">
                    <div class="col-12">
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible">
                                <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;
                                </button>
                                <h5><i class="icon fas fa-check"></i> Уведомление</h5>
                                {{ message }}
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}

            <!-- Main Info Row -->
            <div class="row">
                <!-- Booking Info -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-info-circle mr-1"></i> Основная информация
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <dl>
                                        <dt>Номер бронирования:</dt>
                                        <dd>{{ booking.booking_number }}</dd>

                                        <dt>Создано:</dt>
                                        <dd>{{ booking.created_at|date:"d.m.Y H:i" }}</dd>

                                        <dt>Сотрудник:</dt>
                                        <dd>{{ booking.staff.full_name }}</dd>
                                    </dl>
                                </div>
                                <div class="col-md-6">
                                    <dl>
                                        <dt>Дата заезда:</dt>
                                        <dd>{{ booking.start_date|date:"d.m.Y H:i" }}</dd>

                                        <dt>Дата выезда:</dt>
                                        <dd>{{ booking.end_date|date:"d.m.Y H:i" }}</dd>

                                        <dt>Количество дней:</dt>
                                        <dd>{{ stay_duration }}</dd>
                                    </dl>
                                </div>
                            </div>

                            {% if booking.notes %}
                                <div class="row">
                                    <div class="col-md-12">
                                        <dt>Примечания:</dt>
                                        <dd>{{ booking.notes }}</dd>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Financial Info -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-money-bill mr-1"></i> Финансовая информация
                            </h3>
                        </div>
                        <div class="card-body">
                            <table class="table table-striped">
                                <thead>
                                <tr>
                                    <th>Наименование</th>
                                    <th class="text-right">Стоимость</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for detail in booking_details %}
                                    <tr>
                                        <td>
                                            {{ detail.room.name }} ({{ detail.room.room_type.name }})<br>
                                            <small class="text-muted">{{ detail.tariff.name }}</small>
                                        </td>
                                        <td class="text-right">{{ detail.price|intcomma }}</td>
                                    </tr>
                                {% endfor %}

                                {% if additional_services %}
                                    <tr>
                                        <th colspan="2" class="bg-light">Дополнительные услуги</th>
                                    </tr>
                                    {% for service in additional_services %}
                                        <tr>
                                            <td>
                                                {{ service.service.name }}<br>
                                                <small class="text-muted">Количество: {{ service.quantity }}</small>
                                            </td>
                                            <td class="text-right">{{ service.price|intcomma }}</td>
                                        </tr>
                                    {% endfor %}
                                {% endif %}
                                </tbody>
                                <tfoot>
                                <tr>
                                    <th>Проживание:</th>
                                    <th class="text-right">{{ booking_details_total|intcomma }}</th>
                                </tr>
                                {% if additional_services %}
                                    <tr>
                                        <th>Доп. услуги:</th>
                                        <th class="text-right">{{ additional_services_total }}</th>
                                    </tr>
                                {% endif %}
                                <tr class="bg-light">
                                    <th>Итого:</th>
                                    <th class="text-right">{{ total_price|intcomma }}</th>
                                </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Guests and Rooms Row -->
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-users mr-1"></i> Гости и размещение
                            </h3>
                            <div class="card-tools">
                                {% if booking.status != 'cancelled' and booking.status != 'completed' %}
                                    <a href="{% url 'logus:booking_detail_add' booking.id %}"
                                       class="btn btn-sm btn-success">
                                        <i class="fas fa-plus"></i> Добавить гостя
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered table-striped">
                                    <thead>
                                    <tr>
                                        <th style="width: 25%">Пациент</th>
                                        <th style="width: 20%">Комната</th>
                                        <th style="width: 20%">Тариф</th>
                                        <th style="width: 15%">Цена</th>
                                        <th style="width: 20%">Действия</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for detail in booking_details %}
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <img class="img-circle img-size-32 mr-2"
                                                         src="{% static 'adminlte3_assets/dist/img/avatar.png' %}"
                                                         alt="Patient">
                                                    <div>
                                                        <a href="{% url 'logus:patient_detail' detail.client.id %}">{{ detail.client.full_name }}</a><br>
                                                        {% if detail.client.mobile_phone_number %}
                                                            <small>
                                                                <i class="fas fa-phone mr-1"></i> {{ detail.client.mobile_phone_number }}
                                                            </small>
                                                        {% endif %}
                                                        {% if detail.check_in_log %}
                                                            <div class="mt-1">
                                                                <span class="badge badge-success">
                                                                    Заселен {{ detail.check_in_log.check_in_time|date:"d.m.Y H:i" }}
                                                                </span>
                                                            </div>
                                                        {% elif booking.status == 'confirmed' %}
                                                            <div class="mt-1">
                                                                <span class="badge badge-warning">Ожидает заселения</span>
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <strong>{{ detail.room.name }}</strong><br>
                                                <small class="text-muted">{{ detail.room.room_type.name }}</small>
                                            </td>
                                            <td>
                                                {{ detail.tariff.name }}
                                                {% if detail.tariff.services.exists %}
                                                    <a href="#" data-toggle="tooltip" data-html="true" title="
                                                {% for tariff_service in detail.tariff.tariff_services.all %}
                                                &#8226; {{ tariff_service.service.name }} ({{ tariff_service.sessions_included }} сеансов)<br>
                                                {% endfor %}
                                            ">
                                                        <i class="fas fa-info-circle text-info"></i>
                                                    </a>
                                                {% endif %}
                                            </td>
                                            <td>{{ detail.price }}</td>
                                            <td>
                                                <div class="btn-group">
                                                    <a href="{% url 'logus:booking_detail_view' detail.id %}"
                                                       class="btn btn-sm btn-info"
                                                       data-toggle="tooltip"
                                                       title="Просмотр">
                                                        <i class="fas fa-eye"></i>
                                                    </a>
                                                    {% if booking.status != 'cancelled' and booking.status != 'completed' %}
                                                        <a href="{% url 'logus:booking_detail_edit' detail.id %}"
                                                           class="btn btn-sm btn-warning"
                                                           data-toggle="tooltip"
                                                           title="Редактировать">
                                                            <i class="fas fa-edit"></i>
                                                        </a>
                                                        <a href="{% url 'logus:booking_check_in' detail.id %}"
                                                           class="btn btn-sm {% if detail.check_in_log %}btn-outline-success{% else %}btn-success{% endif %}"
                                                           data-toggle="tooltip"
                                                           title="{% if detail.check_in_log %}Просмотр/обновление данных заселения{% else %}Заполнить чек-лист заселения{% endif %}">
                                                            <i class="fas fa-door-open"></i>
                                                            {% if detail.check_in_log %}Заселено{% else %}Заселить{% endif %}
                                                        </a>
                                                        <button type="button" class="btn btn-sm btn-danger"
                                                                data-toggle="modal"
                                                                data-target="#deleteDetailModal{{ detail.id }}"
                                                                data-toggle="tooltip"
                                                                title="Удалить">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    {% endif %}

                                                    {% if booking.status == 'checked_in' or booking.status == 'confirmed' or booking.status == 'in_progress' %}
                                                        <a href="{% url 'logus:tariff_change' detail.id %}"
                                                           class="btn btn-sm btn-primary"
                                                           data-toggle="tooltip"
                                                           title="Изменить тариф/комнату">
                                                            <i class="fas fa-exchange-alt"></i>
                                                        </a>
                                                    {% endif %}

                                                    {% if booking.status == 'checked_in' %}
                                                        <a href="{% url 'logus:booking_add_service' detail.id %}"
                                                           class="btn btn-sm btn-success"
                                                           data-toggle="tooltip"
                                                           title="Добавить услугу">
                                                            <i class="fas fa-plus"></i> Услуга
                                                        </a>
                                                    {% endif %}
                                                </div>

                                                <!-- Delete Modal -->
                                                <div class="modal fade" id="deleteDetailModal{{ detail.id }}">
                                                    <div class="modal-dialog">
                                                        <div class="modal-content">
                                                            <div class="modal-header">
                                                                <h4 class="modal-title">Удаление гостя из
                                                                    бронирования</h4>
                                                                <button type="button" class="close" data-dismiss="modal"
                                                                        aria-label="Close">
                                                                    <span aria-hidden="true">&times;</span>
                                                                </button>
                                                            </div>
                                                            <div class="modal-body">
                                                                <p>Вы уверены, что хотите удалить
                                                                    гостя {{ detail.client.full_name }} из
                                                                    бронирования?</p>
                                                            </div>
                                                            <div class="modal-footer justify-content-between">
                                                                <button type="button" class="btn btn-default"
                                                                        data-dismiss="modal">Отмена
                                                                </button>
                                                                <form method="post"
                                                                      action="{% url 'logus:booking_detail_delete' detail.id %}">
                                                                    {% csrf_token %}
                                                                    <button type="submit" class="btn btn-danger">
                                                                        Удалить
                                                                    </button>
                                                                </form>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Service Session Tracking Section (TASK-016) -->
            {% if booking.status == 'checked_in' or booking.status == 'in_progress' %}
            <div class="row">
                <div class="col-md-12">
                    <div class="card card-success">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-heartbeat mr-1"></i> Отслеживание сеансов услуг
                            </h3>
                        </div>
                        <div class="card-body">
                            {% for detail in booking_details %}
                                {% if detail.service_tracking_list %}
                                <div class="card mb-3">
                                    <div class="card-header bg-light">
                                        <h5 class="card-title mb-0">
                                            <i class="fas fa-user mr-2"></i>{{ detail.client.full_name }}
                                            <small class="text-muted">- {{ detail.tariff.name }}</small>
                                        </h5>
                                    </div>
                                    <div class="card-body p-0">
                                        <table class="table table-sm mb-0">
                                            <thead>
                                                <tr>
                                                    <th style="width: 30%">Услуга</th>
                                                    <th style="width: 20%" class="text-center">Прогресс</th>
                                                    <th style="width: 15%" class="text-center">Использовано</th>
                                                    <th style="width: 15%" class="text-center">Осталось</th>
                                                    <th style="width: 20%" class="text-center">Действия</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for tracking in detail.service_tracking_list %}
                                                <tr>
                                                    <td>
                                                        <strong>{{ tracking.service.name }}</strong>
                                                        {% if tracking.service.base_price %}
                                                        <br><small class="text-muted">Цена за доп. сеанс: {{ tracking.service.base_price|floatformat:0 }} сум</small>
                                                        {% endif %}
                                                    </td>
                                                    <td class="text-center">
                                                        <div class="progress" style="height: 25px;">
                                                            {% widthratio tracking.sessions_used tracking.sessions_included 100 as percent %}
                                                            <div class="progress-bar {% if percent < 80 %}bg-success{% elif percent < 100 %}bg-warning{% else %}bg-danger{% endif %}"
                                                                 role="progressbar"
                                                                 style="width: {% if percent > 100 %}100{% else %}{{ percent }}{% endif %}%"
                                                                 aria-valuenow="{{ tracking.sessions_used }}"
                                                                 aria-valuemin="0"
                                                                 aria-valuemax="{{ tracking.sessions_included }}">
                                                                {{ tracking.sessions_used }}/{{ tracking.sessions_included }}
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td class="text-center">
                                                        <span class="badge badge-{% if tracking.sessions_used >= tracking.sessions_included %}danger{% else %}success{% endif %} badge-lg">
                                                            {{ tracking.sessions_used }}
                                                        </span>
                                                    </td>
                                                    <td class="text-center">
                                                        <span class="badge badge-{% if tracking.sessions_remaining > 0 %}success{% else %}danger{% endif %} badge-lg">
                                                            {{ tracking.sessions_remaining }}
                                                        </span>
                                                    </td>
                                                    <td class="text-center">
                                                        <a href="{% url 'logus:record_service_session' tracking.id %}"
                                                           class="btn btn-sm btn-{% if tracking.sessions_used >= tracking.sessions_included %}warning{% else %}success{% endif %}">
                                                            <i class="fas fa-check-circle mr-1"></i>
                                                            {% if tracking.sessions_used >= tracking.sessions_included %}
                                                            Записать (доп. оплата)
                                                            {% else %}
                                                            Записать сеанс
                                                            {% endif %}
                                                        </a>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Illness Histories section -->
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-file-medical mr-1"></i> Истории болезни
                            </h3>
                            {% if booking.status == 'checked_in' and illness_histories.count > 0 %}
                                <div class="card-tools">
                                    <a href="#" class="btn btn-primary btn-sm">
                                        <i class="fas fa-plus"></i> Создать новую историю
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                        <div class="card-body">
                            {% if illness_histories %}
                                <table class="table table-bordered">
                                    <thead>
                                    <tr>
                                        <th>№ Истории</th>
                                        <th>Пациент</th>
                                        <th>Тип</th>
                                        <th>Врач</th>
                                        <th>Диагноз</th>
                                        <th>Статус</th>
                                        <th>Действия</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for history in illness_histories %}
                                        <tr>
                                            <td>{{ history.series_number }}</td>
                                            <td>{{ history.patient.full_name }}</td>
                                            <td>
                                                <span class="badge {% if history.type == 'stationary' %}badge-primary{% else %}badge-info{% endif %}">
                                                    {{ history.get_type_display }}
                                                </span>
                                            </td>
                                            <td>
                                                {% if history.doctor %}
                                                    {{ history.doctor.full_name }}
                                                {% else %}
                                                    <span class="text-muted">Не назначен</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if history.diagnosis %}
                                                    {{ history.diagnosis }}
                                                {% elif history.at_arrival_diagnosis %}
                                                    {{ history.at_arrival_diagnosis }}
                                                    <small class="text-muted">(при поступлении)</small>
                                                {% elif history.initial_diagnosis %}
                                                    {{ history.initial_diagnosis }}
                                                    <small class="text-muted">(предварительный)</small>
                                                {% else %}
                                                    <span class="text-muted">Не определен</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <span class="badge
                                                    {% if history.state == 'registration' %}badge-warning
                                                    {% elif history.state == 'open' %}badge-success
                                                    {% elif history.state == 'closed' %}badge-secondary
                                                    {% endif %}">
                                                    {{ history.get_state_display }}
                                                </span>
                                            </td>
                                            <td>
                                                <a href="{% url 'logus:illness_history_detail' history.id %}"
                                                   class="btn btn-info btn-sm">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                {% if history.state != 'closed' %}
                                                    <a href="{% url 'logus:illness_history_edit' history.id %}"
                                                       class="btn btn-warning btn-sm">
                                                        <i class="fas fa-edit"></i>
                                                    </a>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            {% else %}
                                {% if booking.status == 'checked_in' %}
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle"></i> Истории болезни для этой записи еще не созданы.
                                        <a href="#" class="btn btn-primary btn-sm ml-3">
                                            <i class="fas fa-plus"></i> Создать историю болезни
                                        </a>
                                    </div>
                                {% else %}
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle"></i> Истории болезни будут доступны после
                                        заселения гостей.
                                    </div>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- For each guest in the booking details, add illness history info -->
            <!-- Modify your existing guests row to include illness history status -->

            {% if additional_services %}
                <!-- Additional Services Row -->
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <i class="fas fa-concierge-bell mr-1"></i> Дополнительные услуги
                                </h3>
                                <div class="card-tools">
                                    {% if booking.status == 'checked_in' %}
                                        <button type="button" class="btn btn-sm btn-success" data-toggle="modal"
                                                data-target="#addServiceModal">
                                            <i class="fas fa-plus"></i> Добавить услугу
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-bordered table-striped">
                                        <thead>
                                        <tr>
                                            <th>Услуга</th>
                                            <th>Пациент</th>
                                            <th>Количество</th>
                                            <th>Дата</th>
                                            <th>Цена</th>
                                            <th>Примечания</th>
                                            <th>Действия</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        {% for service in additional_services %}
                                            <tr>
                                                <td>{{ service.service.name }}</td>
                                                <td>
                                                    <a href="{% url 'logus:patient_detail' service.booking_detail.client.id %}">
                                                        {{ service.booking_detail.client.full_name }}
                                                    </a>
                                                </td>
                                                <td>{{ service.quantity }}</td>
                                                <td>{{ service.date_used|date:"d.m.Y H:i" }}</td>
                                                <td>{{ service.price }}</td>
                                                <td>{{ service.notes|default:"-" }}</td>
                                                <td>
                                                    <div class="btn-group">
                                                        {% if booking.status == 'checked_in' %}
                                                            <a href="{% url 'logus:service_usage_edit' service.id %}"
                                                               class="btn btn-sm btn-warning">
                                                                <i class="fas fa-edit"></i>
                                                            </a>
                                                            <button type="button" class="btn btn-sm btn-danger"
                                                                    data-toggle="modal"
                                                                    data-target="#deleteServiceModal{{ service.id }}">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        {% endif %}
                                                    </div>

                                                    <!-- Delete Service Modal -->
                                                    <div class="modal fade" id="deleteServiceModal{{ service.id }}">
                                                        <div class="modal-dialog">
                                                            <div class="modal-content">
                                                                <div class="modal-header">
                                                                    <h4 class="modal-title">Удаление услуги</h4>
                                                                    <button type="button" class="close"
                                                                            data-dismiss="modal" aria-label="Close">
                                                                        <span aria-hidden="true">&times;</span>
                                                                    </button>
                                                                </div>
                                                                <div class="modal-body">
                                                                    <p>Вы уверены, что хотите удалить
                                                                        услугу {{ service.service.name }}?</p>
                                                                </div>
                                                                <div class="modal-footer justify-content-between">
                                                                    <button type="button" class="btn btn-default"
                                                                            data-dismiss="modal">Отмена
                                                                    </button>
                                                                    <form method="post"
                                                                          action="{% url 'logus:service_usage_delete' service.id %}">
                                                                        {% csrf_token %}
                                                                        <button type="submit" class="btn btn-danger">
                                                                            Удалить
                                                                        </button>
                                                                    </form>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}

            <!-- Action Buttons Row -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="btn-group">
                                <a href="{% url 'logus:booking_list' %}" class="btn btn-default">
                                    <i class="fas fa-arrow-left mr-1"></i> Назад к списку
                                </a>
                                <a href="{% url 'logus:booking_edit' booking.id %}" class="btn btn-info">
                                    <i class="fas fa-edit mr-1"></i> Редактировать
                                </a>
                            </div>

                            <div class="btn-group float-right">
                                {% if 'confirm' in available_actions %}
                                    <button type="button" class="btn btn-primary" data-toggle="modal"
                                            data-target="#confirmModal">
                                        <i class="fas fa-check mr-1"></i> Подтвердить бронирование
                                    </button>
                                {% endif %}

                                {% if 'checkin' in available_actions %}
                                    <button type="button" class="btn btn-success" data-toggle="modal"
                                            data-target="#checkinModal">
                                        <i class="fas fa-check-circle mr-1"></i> Заселить
                                    </button>
                                {% endif %}

                                {% if 'complete' in available_actions %}
                                    <button type="button" class="btn btn-info" data-toggle="modal"
                                            data-target="#completeModal">
                                        <i class="fas fa-flag-checkered mr-1"></i> Завершить
                                    </button>
                                {% endif %}

                                {% if 'cancel' in available_actions %}
                                    <button type="button" class="btn btn-danger" data-toggle="modal"
                                            data-target="#cancelModal">
                                        <i class="fas fa-times mr-1"></i> Отменить бронирование
                                    </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    {% if 'confirm' in available_actions %}
        <!-- Confirm Booking Modal -->
        <div class="modal fade" id="confirmModal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title">Подтверждение бронирования</h4>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <p>Вы уверены, что хотите подтвердить бронирование #{{ booking.booking_number }}?</p>
                    </div>
                    <div class="modal-footer justify-content-between">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Отмена</button>
                        <form method="post">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="confirm">
                            <button type="submit" class="btn btn-primary">Подтвердить</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    {% if 'checkin' in available_actions %}
        <!-- Check-in Modal -->
        <div class="modal fade" id="checkinModal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title">Заселение</h4>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <p>Подтвердите заселение для бронирования #{{ booking.booking_number }}.</p>
                    </div>
                    <div class="modal-footer justify-content-between">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Отмена</button>
                        <form method="post">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="checkin">
                            <button type="submit" class="btn btn-success">Заселить</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    {% if 'complete' in available_actions %}
        <!-- Complete Booking Modal -->
        <div class="modal fade" id="completeModal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title">Завершение бронирования</h4>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <p>Вы уверены, что хотите отметить бронирование #{{ booking.booking_number }} как
                            завершенное?</p>
                    </div>
                    <div class="modal-footer justify-content-between">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Отмена</button>
                        <form method="post">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="complete">
                            <button type="submit" class="btn btn-info">Завершить</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    {% if 'cancel' in available_actions %}
        <!-- Cancel Booking Modal -->
        <div class="modal fade" id="cancelModal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title">Отмена бронирования</h4>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <p>Вы уверены, что хотите отменить бронирование #{{ booking.booking_number }}?</p>
                        <p class="text-danger">Это действие нельзя отменить.</p>
                    </div>
                    <div class="modal-footer justify-content-between">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Закрыть</button>
                        <form method="post">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="cancel">
                            <button type="submit" class="btn btn-danger">Отменить бронирование</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- TASK-023: Booking History Section -->
    <div class="row">
        <div class="col-md-12">
            <div class="card card-secondary">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-history mr-1"></i> История изменений
                    </h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-tool" data-card-widget="collapse">
                            <i class="fas fa-minus"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    {% if booking_history %}
                        <div class="timeline">
                            {% for history in booking_history %}
                                <div>
                                    <i class="fas {{ history.action_icon }} bg-{{ history.action_color }}"></i>
                                    <div class="timeline-item">
                                        <span class="time">
                                            <i class="fas fa-clock"></i> {{ history.changed_at|date:"d.m.Y H:i" }}
                                        </span>
                                        <h3 class="timeline-header">
                                            {% if history.changed_by %}
                                                <strong>{{ history.changed_by.full_name }}</strong>
                                            {% else %}
                                                <strong>Система</strong>
                                            {% endif %}
                                            - {{ history.get_action_display }}
                                        </h3>
                                        <div class="timeline-body">
                                            {% if history.description %}
                                                <p>{{ history.description }}</p>
                                            {% endif %}

                                            {% if history.field_name %}
                                                <div class="row">
                                                    {% if history.old_value %}
                                                        <div class="col-md-6">
                                                            <strong>Старое значение:</strong>
                                                            <br>
                                                            <span class="text-muted">{{ history.old_value }}</span>
                                                        </div>
                                                    {% endif %}
                                                    {% if history.new_value %}
                                                        <div class="col-md-6">
                                                            <strong>Новое значение:</strong>
                                                            <br>
                                                            <span class="text-success">{{ history.new_value }}</span>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            {% endif %}

                                            {% if history.booking_detail %}
                                                <small class="text-muted">
                                                    Связано с: {{ history.booking_detail.client.full_name }}
                                                </small>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                            <div>
                                <i class="fas fa-clock bg-gray"></i>
                            </div>
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            История изменений пока пуста. Все изменения будут автоматически записываться здесь.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <!-- End Booking History Section -->

    <!-- Add Service Modal -->
    <div class="modal fade" id="addServiceModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Выберите гостя для добавления услуги</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="list-group">
                        {% for detail in booking_details %}
                            <a href="{% url 'logus:booking_add_service' detail.id %}"
                               class="list-group-item list-group-item-action">
                                <div class="d-flex w-100 justify-content-between">
                                    <h5 class="mb-1">{{ detail.client.full_name }}</h5>
                                    <small>Комната: {{ detail.room.name }}</small>
                                </div>
                                <p class="mb-1">Тариф: {{ detail.tariff.name }}</p>
                            </a>
                        {% endfor %}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Отмена</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script>
        function printBooking() {
            window.print();
        }

        $(function () {
            $('[data-toggle="tooltip"]').tooltip();
        });
    </script>
{% endblock %}
