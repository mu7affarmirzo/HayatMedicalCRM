{% extends 'sanatorium/doctors/snippets/base.html' %}
{% load static %}

{% block title %}Заключительные приемы{% endblock %}

{% block extra_css %}
    <!-- Select2 -->
    <link rel="stylesheet" href="{% static 'adminlte3_assets/plugins/select2/css/select2.min.css' %}">
    <link rel="stylesheet" href="{% static 'adminlte3_assets/plugins/select2-bootstrap4-theme/select2-bootstrap4.min.css' %}">
    <!-- DataTables -->
    <link rel="stylesheet" href="{% static 'adminlte3_assets/plugins/datatables-bs4/css/dataTables.bootstrap4.min.css' %}">
    <link rel="stylesheet" href="{% static 'adminlte3_assets/plugins/datatables-responsive/css/responsive.bootstrap4.min.css' %}">
    <style>
        .appointment-card {
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            border-radius: 10px;
        }
        .appointment-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .status-badge {
            font-size: 0.75rem;
            padding: 0.375rem 0.75rem;
            border-radius: 20px;
        }
        .result-indicator {
            width: 4px;
            height: 100%;
            position: absolute;
            left: 0;
            top: 0;
            border-radius: 10px 0 0 10px;
        }
        .result-improvement { background-color: #28a745; }
        .result-stable { background-color: #ffc107; }
        .result-decline { background-color: #dc3545; }
        .quick-stats {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 1.5rem;
        }
        .filter-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 15px;
            padding: 1.5rem;
        }
        .export-section {
            position: sticky;
            top: 20px;
            z-index: 100;
        }
        .pagination-info {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
        }
    </style>
{% endblock %}

{% block content %}
    <!-- Content Header (Page header) -->
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0">
                        <i class="fas fa-file-medical text-primary mr-2"></i>
                        Заключительные приемы
                    </h1>
                    <p class="text-muted">Управление заключительными приемами пациентов</p>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="{% url 'sanatorium.doctors:doctors_main_screen' %}">Главная</a></li>
                        <li class="breadcrumb-item active">Заключительные приемы</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
    <!-- /.content-header -->

    <!-- Main content -->
    <section class="content">
        <div class="container-fluid">
            <!-- Success/Error Messages -->
            {% if messages %}
                <div class="row">
                    <div class="col-md-12">
                        {% for message in messages %}
                            <div class="alert alert-{% if message.tags == 'success' %}success{% elif message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible">
                                <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
                                <h5>
                                    <i class="icon fas {% if message.tags == 'success' %}fa-check{% else %}fa-exclamation-triangle{% endif %}"></i> 
                                    {{ message }}
                                </h5>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}

            <div class="row">
                <!-- Filters and Export Sidebar -->
                <div class="col-md-3">
                    <div class="export-section">
                        <!-- Quick Stats -->
                        <div class="card">
                            <div class="card-body quick-stats text-center">
                                <h5 class="mb-3">
                                    <i class="fas fa-chart-bar mr-2"></i>Статистика
                                </h5>
                                <div class="row">
                                    <div class="col-6">
                                        <div class="h3 mb-0">{{ appointments|length }}</div>
                                        <div class="small">Всего приемов</div>
                                    </div>
                                    <div class="col-6">
                                        <div class="h3 mb-0">{{ appointments|length }}</div>
                                        <div class="small">За месяц</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Filters -->
                        <div class="card">
                            <div class="card-body filter-card">
                                <h5 class="mb-3">
                                    <i class="fas fa-filter mr-2"></i>Фильтры
                                </h5>
                                <form method="get" id="filterForm">
                                    <div class="form-group">
                                        <input type="text" name="search" class="form-control" 
                                               placeholder="Поиск по пациенту..." 
                                               value="{{ search_query }}">
                                    </div>
                                    
                                    <div class="form-group">
                                        <select name="status" class="form-control select2">
                                            <option value="">Все статусы</option>
                                            <option value="Приём завершён" {% if status_filter == 'Приём завершён' %}selected{% endif %}>Завершенные</option>
                                            <option value="Не завершено" {% if status_filter == 'Не завершено' %}selected{% endif %}>Не завершенные</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <input type="date" name="date_from" class="form-control" 
                                               value="{{ request.GET.date_from }}">
                                    </div>
                                    
                                    <div class="form-group">
                                        <input type="date" name="date_to" class="form-control" 
                                               value="{{ request.GET.date_to }}">
                                    </div>
                                    
                                    <div class="form-group">
                                        <select name="treatment_result" class="form-control select2">
                                            <option value="">Все результаты</option>
                                            <option value="Улучение" {% if request.GET.treatment_result == 'Улучение' %}selected{% endif %}>Улучшение</option>
                                            <option value="Без изменения" {% if request.GET.treatment_result == 'Без изменения' %}selected{% endif %}>Без изменения</option>
                                            <option value="Ухудшение" {% if request.GET.treatment_result == 'Ухудшение' %}selected{% endif %}>Ухудшение</option>
                                        </select>
                                    </div>
                                    
                                    <button type="submit" class="btn btn-light btn-block">
                                        <i class="fas fa-search mr-1"></i>Применить
                                    </button>
                                    <a href="#" class="btn btn-outline-light btn-block">
                                        <i class="fas fa-undo mr-1"></i>Сбросить
                                    </a>
                                </form>
                            </div>
                        </div>

                        <!-- Export Options -->
                        <div class="card card-info">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <i class="fas fa-download mr-2"></i>Экспорт данных
                                </h3>
                            </div>
                            <div class="card-body">
                                <button type="button" class="btn btn-outline-info btn-block mb-2" onclick="exportToExcel()">
                                    <i class="fas fa-file-excel mr-1"></i>Excel отчет
                                </button>
                                <button type="button" class="btn btn-outline-info btn-block mb-2" onclick="exportToPDF()">
                                    <i class="fas fa-file-pdf mr-1"></i>PDF сводка
                                </button>
                                <button type="button" class="btn btn-outline-info btn-block" onclick="printList()">
                                    <i class="fas fa-print mr-1"></i>Печать списка
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Content Area -->
                <div class="col-md-9">
                    <!-- View Toggle -->
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h3 class="card-title">
                                    <i class="fas fa-list mr-2"></i>Список заключительных приемов
                                </h3>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-outline-primary active" id="cardViewBtn" onclick="switchView('card')">
                                        <i class="fas fa-th-large"></i> Карточки
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" id="tableViewBtn" onclick="switchView('table')">
                                        <i class="fas fa-table"></i> Таблица
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Card View -->
                            <div id="cardView">
                                {% if appointments %}
                                    <div class="row">
                                        {% for appointment in appointments %}
                                            <div class="col-md-6 mb-4">
                                                <div class="card appointment-card h-100 position-relative" 
                                                     onclick="viewAppointment({{ appointment.pk }})">
                                                    <div class="result-indicator result-{% if appointment.treatment_results == 'Улучение' %}improvement{% elif appointment.treatment_results == 'Без изменения' %}stable{% else %}decline{% endif %}"></div>
                                                    
                                                    <div class="card-body">
                                                        <div class="d-flex justify-content-between align-items-start mb-3">
                                                            <div>
                                                                <h6 class="card-title mb-1">{{ appointment.illness_history.patient.full_name }}</h6>
                                                                <small class="text-muted">{{ appointment.illness_history.patient.date_of_birth|date:"d.m.Y" }}</small>
                                                            </div>
                                                            <span class="status-badge badge-{% if appointment.state == 'Приём завершён' %}success{% else %}warning{% endif %}">
                                                                {{ appointment.state }}
                                                            </span>
                                                        </div>
                                                        
                                                        <div class="mb-3">
                                                            <div class="row text-center">
                                                                <div class="col-6">
                                                                    <div class="font-weight-bold">{{ appointment.created_at|date:"d.m.Y" }}</div>
                                                                    <div class="small text-muted">Дата приема</div>
                                                                </div>
                                                                <div class="col-6">
                                                                    <div class="font-weight-bold">{{ appointment.doctor.full_name|truncatechars:20 }}</div>
                                                                    <div class="small text-muted">Врач</div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        
                                                        <div class="mb-3">
                                                            <strong>Результат лечения:</strong>
                                                            <span class="text-{% if appointment.treatment_results == 'Улучение' %}success{% elif appointment.treatment_results == 'Без изменения' %}warning{% else %}danger{% endif %}">
                                                                {{ appointment.treatment_results }}
                                                            </span>
                                                        </div>
                                                        
                                                        {% if appointment.diagnosis.exists %}
                                                        <div class="mb-3">
                                                            <small class="text-muted">Диагнозы:</small><br>
                                                            {% for diagnosis in appointment.diagnosis.all|slice:":2" %}
                                                                <span class="badge badge-secondary mr-1">{{ diagnosis.name|truncatechars:30 }}</span>
                                                            {% endfor %}
                                                            {% if appointment.diagnosis.count > 2 %}
                                                                <span class="badge badge-light">+{{ appointment.diagnosis.count|add:"-2" }}</span>
                                                            {% endif %}
                                                        </div>
                                                        {% endif %}
                                                    </div>
                                                    
                                                    <div class="card-footer">
                                                        <div class="btn-group btn-group-sm w-100" role="group">
                                                            <button type="button" class="btn btn-outline-info" onclick="event.stopPropagation(); viewAppointment({{ appointment.pk }})">
                                                                <i class="fas fa-eye"></i>
                                                            </button>
                                                            <button type="button" class="btn btn-outline-warning" onclick="event.stopPropagation(); editAppointment({{ appointment.pk }})">
                                                                <i class="fas fa-edit"></i>
                                                            </button>
                                                            <button type="button" class="btn btn-outline-danger" onclick="event.stopPropagation(); exportPDF({{ appointment.pk }})">
                                                                <i class="fas fa-file-pdf"></i>
                                                            </button>
                                                            <button type="button" class="btn btn-outline-success" onclick="event.stopPropagation(); exportWord({{ appointment.pk }})">
                                                                <i class="fas fa-file-word"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <div class="text-center py-5">
                                        <i class="fas fa-file-medical fa-4x text-muted mb-3"></i>
                                        <h4 class="text-muted">Заключительные приемы не найдены</h4>
                                        <p class="text-muted">Попробуйте изменить параметры поиска или создайте новый заключительный прием</p>
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Table View -->
                            <div id="tableView" style="display: none;">
                                {% if appointments %}
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover" id="appointmentsTable">
                                            <thead>
                                                <tr>
                                                    <th>Пациент</th>
                                                    <th>Врач</th>
                                                    <th>Дата приема</th>
                                                    <th>Статус</th>
                                                    <th>Результат лечения</th>
                                                    <th>Диагнозы</th>
                                                    <th>Действия</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for appointment in appointments %}
                                                <tr onclick="viewAppointment({{ appointment.pk }})" style="cursor: pointer;">
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <div class="result-indicator result-{% if appointment.treatment_results == 'Улучение' %}improvement{% elif appointment.treatment_results == 'Без изменения' %}stable{% else %}decline{% endif %}" 
                                                                 style="width: 3px; height: 30px; margin-right: 10px;"></div>
                                                            <div>
                                                                <div class="font-weight-bold">{{ appointment.illness_history.patient.full_name }}</div>
                                                                <small class="text-muted">{{ appointment.illness_history.patient.date_of_birth|date:"d.m.Y" }}</small>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>{{ appointment.doctor.full_name }}</td>
                                                    <td>{{ appointment.created_at|date:"d.m.Y H:i" }}</td>
                                                    <td>
                                                        <span class="badge badge-{% if appointment.state == 'Приём завершён' %}success{% else %}warning{% endif %}">
                                                            {{ appointment.state }}
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <span class="text-{% if appointment.treatment_results == 'Улучение' %}success{% elif appointment.treatment_results == 'Без изменения' %}warning{% else %}danger{% endif %}">
                                                            {{ appointment.treatment_results }}
                                                        </span>
                                                    </td>
                                                    <td>
                                                        {% if appointment.diagnosis.exists %}
                                                            {% for diagnosis in appointment.diagnosis.all|slice:":1" %}
                                                                {{ diagnosis.name|truncatechars:40 }}
                                                            {% endfor %}
                                                            {% if appointment.diagnosis.count > 1 %}
                                                                <small class="text-muted">(+{{ appointment.diagnosis.count|add:"-1" }})</small>
                                                            {% endif %}
                                                        {% else %}
                                                            <span class="text-muted">Не указаны</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        <div class="btn-group btn-group-sm" role="group">
                                                            <button type="button" class="btn btn-outline-info" onclick="event.stopPropagation(); viewAppointment({{ appointment.pk }})" title="Просмотр">
                                                                <i class="fas fa-eye"></i>
                                                            </button>
                                                            <button type="button" class="btn btn-outline-warning" onclick="event.stopPropagation(); editAppointment({{ appointment.pk }})" title="Редактировать">
                                                                <i class="fas fa-edit"></i>
                                                            </button>
                                                            <div class="btn-group btn-group-sm" role="group">
                                                                <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-toggle="dropdown" title="Экспорт">
                                                                    <i class="fas fa-download"></i>
                                                                </button>
                                                                <div class="dropdown-menu">
                                                                    <a class="dropdown-item" href="#" onclick="exportPDF({{ appointment.pk }})">
                                                                        <i class="fas fa-file-pdf mr-1"></i> PDF
                                                                    </a>
                                                                    <a class="dropdown-item" href="#" onclick="exportWord({{ appointment.pk }})">
                                                                        <i class="fas fa-file-word mr-1"></i> Word
                                                                    </a>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                {% else %}
                                    <div class="text-center py-5">
                                        <i class="fas fa-file-medical fa-4x text-muted mb-3"></i>
                                        <h4 class="text-muted">Заключительные приемы не найдены</h4>
                                        <p class="text-muted">Попробуйте изменить параметры поиска</p>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Pagination -->
                    {% if is_paginated %}
                        <div class="pagination-info">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    Показано {{ page_obj.start_index }}-{{ page_obj.end_index }} из {{ page_obj.paginator.count }} записей
                                </div>
                                <nav aria-label="Навигация по страницам">
                                    <ul class="pagination mb-0">
                                        {% if page_obj.has_previous %}
                                            <li class="page-item">
                                                <a class="page-link" href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">&laquo; Первая</a>
                                            </li>
                                            <li class="page-item">
                                                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">Предыдущая</a>
                                            </li>
                                        {% endif %}

                                        <li class="page-item active">
                                            <span class="page-link">
                                                Страница {{ page_obj.number }} из {{ page_obj.paginator.num_pages }}
                                            </span>
                                        </li>

                                        {% if page_obj.has_next %}
                                            <li class="page-item">
                                                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">Следующая</a>
                                            </li>
                                            <li class="page-item">
                                                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">Последняя &raquo;</a>
                                            </li>
                                        {% endif %}
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </section>
{% endblock %}

{% block extra_js %}
    <!-- Select2 -->
    <script src="{% static 'adminlte3_assets/plugins/select2/js/select2.full.min.js' %}"></script>
    <!-- DataTables -->
    <script src="{% static 'adminlte3_assets/plugins/datatables/jquery.dataTables.min.js' %}"></script>
    <script src="{% static 'adminlte3_assets/plugins/datatables-bs4/js/dataTables.bootstrap4.min.js' %}"></script>
    <script src="{% static 'adminlte3_assets/plugins/datatables-responsive/js/dataTables.responsive.min.js' %}"></script>
    
    <script>
        $(function() {
            // Initialize Select2
            $('.select2').select2({
                theme: 'bootstrap4'
            });

            // Initialize DataTable for table view
            $('#appointmentsTable').DataTable({
                "responsive": true,
                "autoWidth": false,
                "paging": false,
                "info": false,
                "searching": false,
                "ordering": true,
                "order": [[2, "desc"]], // Sort by date descending
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.10.21/i18n/Russian.json"
                }
            });

            // Auto-submit filter form on change
            $('#filterForm select, #filterForm input[type="date"]').on('change', function() {
                $('#filterForm').submit();
            });

            // Submit filter form on Enter for search input
            $('#filterForm input[name="search"]').on('keypress', function(e) {
                if (e.which === 13) {
                    $('#filterForm').submit();
                }
            });
        });

        function switchView(viewType) {
            if (viewType === 'card') {
                $('#cardView').show();
                $('#tableView').hide();
                $('#cardViewBtn').addClass('active');
                $('#tableViewBtn').removeClass('active');
            } else {
                $('#cardView').hide();
                $('#tableView').show();
                $('#cardViewBtn').removeClass('active');
                $('#tableViewBtn').addClass('active');
            }
            
            // Save preference to localStorage
            localStorage.setItem('appointmentViewType', viewType);
        }

        function viewAppointment(appointmentId) {
            window.location.href = "{% url 'sanatorium.doctors:final_appointment_enhanced_detail' 0 %}".replace('0', appointmentId);
        }

        function editAppointment(appointmentId) {
            window.location.href = "{% url 'sanatorium.doctors:final_appointment_enhanced_update' 0 %}".replace('0', appointmentId);
        }

        function exportPDF(appointmentId) {
            window.open("{% url 'sanatorium.doctors:final_appointment_export_pdf' 0 %}".replace('0', appointmentId), '_blank');
        }

        function exportWord(appointmentId) {
            window.open("{% url 'sanatorium.doctors:final_appointment_export_word' 0 %}".replace('0', appointmentId), '_blank');
        }

        function exportToExcel() {
            // Implement Excel export functionality
            alert('Функция экспорта в Excel будет реализована');
        }

        function exportToPDF() {
            // Implement PDF summary export functionality
            alert('Функция экспорта сводки в PDF будет реализована');
        }

        function printList() {
            window.print();
        }

        // Load saved view preference
        $(document).ready(function() {
            const savedView = localStorage.getItem('appointmentViewType');
            if (savedView) {
                switchView(savedView);
            }
        });
    </script>
{% endblock %}