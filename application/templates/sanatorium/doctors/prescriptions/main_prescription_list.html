{% extends 'sanatorium/doctors/snippets/base.html' %}
{% load static %}
{% block title %}Основной лист назначений | Hayat Medical Center{% endblock %}
{% block extra_css %}
    <style>
        .prescription-card {
            transition: all 0.3s;
        }

        .prescription-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .status-badge {
            font-size: 0.8rem;
        }

        .status-recommended {
            background-color: #17a2b8;
        }

        .status-assigned {
            background-color: #007bff;
        }

        .status-cancelled {
            background-color: #dc3545;
        }

        .status-stopped {
            background-color: #ffc107;
            color: #212529;
        }

        .status-dispatched {
            background-color: #28a745;
        }

        .status-completed {
            background-color: #28a745;
        }

        .status-pending {
            background-color: #6c757d;
        }

        .progress-xs {
            height: 5px;
        }

        .table td, .table th {
            vertical-align: middle;
        }

        .nav-pills .nav-link.active {
            background-color: #007bff;
        }

        /* Progress bar styles */
        .progress {
            border-radius: 2px;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
            margin-bottom: 0;
        }

        .progress-bar-animated {
            animation: progress-bar-stripes 1s linear infinite;
        }

        .progress-bar-striped {
            background-image: linear-gradient(45deg, rgba(255, 255, 255, .15) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, .15) 50%, rgba(255, 255, 255, .15) 75%, transparent 75%, transparent);
            background-size: 1rem 1rem;
        }

        /* Add hover effect to rows */
        tbody tr {
            transition: background-color 0.2s;
        }

        tbody tr:hover {
            background-color: rgba(0, 0, 0, 0.03);
        }

        /* Progress group in info boxes */
        .progress-group {
            margin-bottom: 0.5rem;
        }

        .progress-group .progress-text {
            font-weight: 600;
        }

        .progress-group .progress-number {
            float: right;
            font-weight: 600;
        }

        .progress-sm {
            height: 5px;
        }
    </style>
{% endblock %}
{% block content %}
    <!-- Content Header (Page header) -->
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0">Основной лист назначений</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="#">Главная</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'illness_history_detail' history.id %}">История
                            болезни #{{ history.series_number }}</a></li>
                        <li class="breadcrumb-item active">Основной лист назначений</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
    <!-- /.content-header -->
    <!-- Main content -->
    <section class="content">
        <div class="container-fluid">
            <!-- Info boxes -->
            <div class="row">
                <div class="col-12 col-sm-6 col-md-4">
                    <div class="info-box">
                        <span class="info-box-icon bg-info elevation-1"><i class="fas fa-stethoscope"></i></span>
                        <div class="info-box-content">
                            <span class="info-box-text">Консультации и исследования</span>
                            <span class="info-box-number">{{ total_consultations_count }}</span>
                            {% if total_consultations_count > 0 %}
                                <div class="progress-group mt-2">
                                    <div class="progress progress-sm">
                                        <div class="progress-bar bg-info"
                                             style="width: {{ completed_total_percent }}%"></div>
                                    </div>
                                    <small class="text-muted">Выполнено {{ completed_total }}
                                        из {{ total_consultations_count }}</small>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-md-4">
                    <div class="info-box">
                        <span class="info-box-icon bg-success elevation-1"><i class="fas fa-procedures"></i></span>
                        <div class="info-box-content">
                            <span class="info-box-text">Лечебные процедуры</span>
                            <span class="info-box-number">{{ procedure_count }}</span>
                            {% if procedure_count > 0 %}
                                <div class="progress-group mt-2">
                                    <div class="progress progress-sm">
                                        <div class="progress-bar bg-success"
                                             style="width: {{ total_procedures_percent }}%"></div>
                                    </div>
                                    <small class="text-muted">Выполнено {{ total_completed_sessions }}
                                        из {{ total_sessions }} сеансов</small>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-md-4">
                    <div class="info-box">
                        <span class="info-box-icon bg-warning elevation-1"><i class="fas fa-pills"></i></span>
                        <div class="info-box-content">
                            <span class="info-box-text">Медикаменты</span>
                            <span class="info-box-number">{{ medication_count }}</span>
                            {% if medication_count > 0 %}
                                <div class="progress-group mt-2">
                                    <div class="progress progress-sm">
                                        <div class="progress-bar bg-warning"
                                             style="width: {{ active_medications_percent }}%"></div>
                                    </div>
                                    <small class="text-muted">Активных курсов: {{ active_medications }}
                                        из {{ medication_count }}</small>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            <!-- Tab navigation -->
            <div class="card">
                <div class="card-header p-2">
                    <ul class="nav nav-pills">
                        <li class="nav-item"><a class="nav-link active" href="#consultations" data-toggle="tab">Консультации
                            и исследования</a></li>
                        <li class="nav-item"><a class="nav-link" href="#procedures" data-toggle="tab">Лечебные
                            процедуры</a></li>
                        <li class="nav-item"><a class="nav-link" href="#medications" data-toggle="tab">Медикаменты</a>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content">
                        <!-- Consultations and Examinations Tab -->
                        <div class="tab-pane active" id="consultations">
                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <a href="#" class="btn btn-primary">
                                        <i class="fas fa-plus"></i> Добавить консультацию/исследование
                                    </a>
                                </div>
                            </div>

                            {% if consultations %}
                                <div class="table-responsive">
                                    <table class="table table-bordered table-hover">
                                        <thead>
                                        <tr>
                                            <th>№</th>
                                            <th>Название</th>
                                            <th>Врач</th>
                                            <th>Статус</th>
                                            <th>Дата назначения</th>
                                            <th>Действия</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        {% for consultation in consultations %}
                                            <tr>
                                                <td>{{ forloop.counter }}</td>
                                                <td>{{ consultation.medical_service.name }}</td>
                                                <td>
                                                    {{ consultation.consulted_doctor.full_name|default:"Не назначен" }}</td>
                                                <td>
                                        <span class="badge status-{{ consultation.state }}">
                                            {{ consultation.get_state_display }}
                                        </span>
                                                </td>
                                                <td>{{ consultation.created_at|date:"d.m.Y" }}</td>
                                                <td>
                                                    <div class="btn-group btn-group-sm">
                                                        <a href="#" class="btn btn-info">
                                                            <i class="fas fa-eye"></i>
                                                        </a>
                                                        <a href="#" class="btn btn-warning">
                                                            <i class="fas fa-edit"></i>
                                                        </a>
                                                        <button type="button" class="btn btn-primary"
                                                                data-toggle="modal"
                                                                data-target="#sessionModal{{ procedure.id }}">
                                                            <i class="fas fa-calendar-check"></i>
                                                        </button>
                                                        <a href="#" class="btn btn-danger">
                                                            <i class="fas fa-trash"></i>
                                                        </a>
                                                    </div>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td colspan="6" class="p-0">
                                                    <div class="progress progress-xs m-0"
                                                         style="height: 3px; border-radius: 0;">
                                                        {% if consultation.state == 'recommended' %}
                                                            <div class="progress-bar bg-info" style="width: 25%"></div>
                                                        {% elif consultation.state == 'assigned' %}
                                                            <div class="progress-bar bg-primary"
                                                                 style="width: 50%"></div>
                                                        {% elif consultation.state == 'dispatched' %}
                                                            <div class="progress-bar bg-success"
                                                                 style="width: 100%"></div>
                                                        {% elif consultation.state == 'cancelled' %}
                                                            <div class="progress-bar bg-danger"
                                                                 style="width: 100%"></div>
                                                        {% elif consultation.state == 'stopped' %}
                                                            <div class="progress-bar bg-warning"
                                                                 style="width: 75%"></div>
                                                        {% endif %}
                                                    </div>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle mr-2"></i>
                                    Нет назначенных консультаций и исследований
                                </div>
                            {% endif %}
                        </div>

                        <!-- Procedures Tab -->
                        <div class="tab-pane" id="procedures">
                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <a href="#" class="btn btn-primary">
                                        <i class="fas fa-plus"></i> Добавить лечебную процедуру
                                    </a>
                                </div>
                            </div>

                            {% if procedures %}
                                <div class="table-responsive">
                                    <table class="table table-bordered table-hover">
                                        <thead>
                                        <tr>
                                            <th>№</th>
                                            <th>Название</th>
                                            <th>Терапевт</th>
                                            <th>Начало</th>
                                            <th>Частота</th>
                                            <th>Прогресс</th>
                                            <th>Статус</th>
                                            <th>Действия</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        {% for procedure in procedures %}
                                            <tr>
                                                <td>{{ forloop.counter }}</td>
                                                <td>{{ procedure.medical_service.name }}</td>
                                                <td>{{ procedure.therapist.full_name|default:"Не назначен" }}</td>
                                                <td>{{ procedure.start_date|date:"d.m.Y" }}</td>
                                                <td>{{ procedure.frequency }}</td>
                                                <td>
                                                    <div class="position-relative" style="height: 24px;">
                                                        <div class="progress" style="height: 24px;">
                                                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                                                                 role="progressbar"
                                                                 style="width: {{ procedure.progres_percentile }}%"
                                                                 aria-valuenow="{{ procedure.proceeded_sessions }}"
                                                                 aria-valuemin="0"
                                                                 aria-valuemax="{{ procedure.quantity }}">
                                                            </div>
                                                        </div>
                                                        <div class="position-absolute d-flex justify-content-center align-items-center"
                                                             style="top: 0; left: 0; right: 0; bottom: 0; font-weight: bold;">
                                                            <span>{{ procedure.proceeded_sessions }}/{{ procedure.quantity }}</span>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>
                                        <span class="badge status-{{ procedure.state }}">
                                            {{ procedure.get_state_display }}
                                        </span>
                                                </td>
                                                <td>
                                                    <div class="btn-group btn-group-sm">
                                                        <a href="#" class="btn btn-info" data-toggle="modal"
                                                           data-target="#sessionModal{{ procedure.id }}">
                                                            <i class="fas fa-eye"></i>
                                                        </a>
                                                        <a href="#" class="btn btn-warning">
                                                            <i class="fas fa-edit"></i>
                                                        </a>
                                                        <a href="#" class="btn btn-danger">
                                                            <i class="fas fa-trash"></i>
                                                        </a>
                                                    </div>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                <!-- Session details for procedures -->
                                <!-- Modal dialogs for each procedure -->
                                {% for procedure in procedures %}
                                    <!-- Modal for procedure {{ procedure.id }} -->
                                    <div class="modal fade" id="sessionModal{{ procedure.id }}" tabindex="-1"
                                         role="dialog" aria-labelledby="sessionModalLabel{{ procedure.id }}"
                                         aria-hidden="true">
                                        <div class="modal-dialog modal-lg">
                                            <div class="modal-content">
                                                <div class="modal-header bg-primary text-white">
                                                    <h5 class="modal-title" id="sessionModalLabel{{ procedure.id }}">
                                                        <i class="fas fa-calendar-alt mr-2"></i>Управление
                                                        сеансами: {{ procedure.medical_service.name }}
                                                    </h5>
                                                    <button type="button" class="close text-white" data-dismiss="modal"
                                                            aria-label="Close">
                                                        <span aria-hidden="true">&times;</span>
                                                    </button>
                                                </div>
                                                <div class="modal-body">
                                                    <div class="row mb-3">
                                                        <div class="col-md-6">
                                                            <div class="d-flex align-items-center">
                                                                <div class="mr-3">
                                                    <span class="badge badge-pill badge-primary p-2">
                                                        <i class="fas fa-prescription-bottle-alt"></i>
                                                    </span>
                                                                </div>
                                                                <div>
                                                                    <h6 class="mb-0">Процедура</h6>
                                                                    <p class="text-muted mb-0">{{ procedure.medical_service.name }}</p>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="d-flex align-items-center">
                                                                <div class="mr-3">
                                                    <span class="badge badge-pill badge-info p-2">
                                                        <i class="fas fa-user-md"></i>
                                                    </span>
                                                                </div>
                                                                <div>
                                                                    <h6 class="mb-0">Терапевт</h6>
                                                                    <p class="text-muted mb-0">
                                                                        {{ procedure.therapist.full_name|default:"Не назначен" }}</p>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="row mb-3">
                                                        <div class="col-md-4">
                                                            <div class="d-flex align-items-center">
                                                                <div class="mr-3">
                                                    <span class="badge badge-pill badge-success p-2">
                                                        <i class="fas fa-calendar-day"></i>
                                                    </span>
                                                                </div>
                                                                <div>
                                                                    <h6 class="mb-0">Дата начала</h6>
                                                                    <p class="text-muted mb-0">
                                                                        {{ procedure.start_date|date:"d.m.Y" }}</p>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <div class="d-flex align-items-center">
                                                                <div class="mr-3">
                                                    <span class="badge badge-pill badge-warning p-2">
                                                        <i class="fas fa-sync-alt"></i>
                                                    </span>
                                                                </div>
                                                                <div>
                                                                    <h6 class="mb-0">Частота</h6>
                                                                    <p class="text-muted mb-0">{{ procedure.frequency }}</p>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <div class="d-flex align-items-center">
                                                                <div class="mr-3">
                                                    <span class="badge badge-pill badge-secondary p-2">
                                                        <i class="fas fa-hashtag"></i>
                                                    </span>
                                                                </div>
                                                                <div>
                                                                    <h6 class="mb-0">Статус</h6>
                                                                    <p class="mb-0">
                                                        <span class="badge status-{{ procedure.state }}">
                                                            {{ procedure.get_state_display }}
                                                        </span>
                                                                    </p>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="progress mb-3" style="height: 15px;">
                                                        <div class="progress-bar bg-success progress-bar-striped progress-bar-animated"
                                                             style="width: {{ procedure.progres_percentile }}%"
                                                             role="progressbar"
                                                             aria-valuenow="{{ procedure.proceeded_sessions }}"
                                                             aria-valuemin="0"
                                                             aria-valuemax="{{ procedure.quantity }}">
                                                            {{ procedure.proceeded_sessions }}/{{ procedure.quantity }}
                                                        </div>
                                                    </div>

                                                    <h5 class="mt-4 mb-3">
                                                        <i class="fas fa-list-ol mr-2"></i>Список сеансов
                                                        <button class="btn btn-sm btn-outline-primary float-right">
                                                            <i class="fas fa-plus"></i> Добавить сеанс
                                                        </button>
                                                    </h5>

                                                    <form id="sessionForm{{ procedure.id }}">
                                                        <div class="table-responsive">
                                                            <table class="table table-bordered table-hover">
                                                                <thead class="thead-light">
                                                                <tr>
                                                                    <th style="width: 5%">№</th>
                                                                    <th style="width: 20%">Статус</th>
                                                                    <th style="width: 30%">Терапевт</th>
                                                                    <th style="width: 25%">Дата</th>
                                                                    <th style="width: 20%">Действия</th>
                                                                </tr>
                                                                </thead>
                                                                <tbody>
                                                                {% for session in procedure.individual_sessions.all %}
                                                                    <tr class="{% if session.status == 'completed' %}table-success{% elif session.status == 'canceled' %}table-danger{% endif %}">
                                                                        <td class="text-center">{{ session.session_number }}</td>
                                                                        <td>
                                                                            <select class="form-control form-control-sm session-status-select"
                                                                                    name="status_{{ session.id }}">
                                                                                <option value="pending"
                                                                                        {% if session.status == 'pending' %}selected{% endif %}>
                                                                                    Ожидает
                                                                                </option>
                                                                                <option value="completed"
                                                                                        {% if session.status == 'completed' %}selected{% endif %}>
                                                                                    Проведен
                                                                                </option>
                                                                                <option value="canceled"
                                                                                        {% if session.status == 'canceled' %}selected{% endif %}>
                                                                                    Отменен
                                                                                </option>
                                                                            </select>
                                                                        </td>
                                                                        <td>
                                                                            <select class="form-control form-control-sm"
                                                                                    name="therapist_{{ session.id }}">
                                                                                <option value="">-- Выберите терапевта
                                                                                    --
                                                                                </option>
                                                                                <!-- Here you would dynamically populate with available therapists -->
                                                                                <option value="1"
                                                                                        {% if session.therapist and session.therapist.id == 1 %}selected{% endif %}>
                                                                                    Терапевт 1
                                                                                </option>
                                                                                <option value="2"
                                                                                        {% if session.therapist and session.therapist.id == 2 %}selected{% endif %}>
                                                                                    Терапевт 2
                                                                                </option>
                                                                            </select>
                                                                        </td>
                                                                        <td>
                                                                            <input type="datetime-local"
                                                                                   class="form-control form-control-sm"
                                                                                   name="date_{{ session.id }}"
                                                                                   value="



                                                                                           {% if session.completed_at %}{{ session.completed_at|date:'Y-m-d\TH:i' }}{% endif %}">
                                                                        </td>
                                                                        <td class="text-center">
                                                                            <button type="button"
                                                                                    class="btn btn-sm btn-success save-session-btn"
                                                                                    data-session-id="{{ session.id }}">
                                                                                <i class="fas fa-save"></i>
                                                                            </button>
                                                                            <button type="button"
                                                                                    class="btn btn-sm btn-info"
                                                                                    data-toggle="collapse"
                                                                                    data-target="#sessionNotes{{ session.id }}"
                                                                                    aria-expanded="false">
                                                                                <i class="fas fa-sticky-note"></i>
                                                                            </button>
                                                                        </td>
                                                                    </tr>
                                                                    <tr class="collapse"
                                                                        id="sessionNotes{{ session.id }}">
                                                                        <td colspan="5" class="bg-light">
                                                                            <div class="form-group mb-0">
                                                                                <label for="notes_{{ session.id }}">Примечания:</label>
                                                                                <textarea class="form-control"
                                                                                          id="notes_{{ session.id }}"
                                                                                          name="notes_{{ session.id }}"
                                                                                          rows="2">{{ session.notes|default:'' }}</textarea>
                                                                            </div>
                                                                        </td>
                                                                    </tr>
                                                                    {% empty %}
                                                                    <tr>
                                                                        <td colspan="5" class="text-center">Нет
                                                                            запланированных сеансов
                                                                        </td>
                                                                    </tr>
                                                                {% endfor %}
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </form>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary"
                                                            data-dismiss="modal">Закрыть
                                                    </button>
                                                    <button type="button" class="btn btn-primary save-all-sessions"
                                                            data-procedure-id="{{ procedure.id }}">
                                                        <i class="fas fa-save mr-1"></i> Сохранить все изменения
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}

                                <!-- Original session cards - can be removed or kept for quick overview -->
                            {% else %}
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle mr-2"></i>
                                    Нет назначенных лечебных процедур
                                </div>
                            {% endif %}
                        </div>

                        <!-- Medications Tab -->
                        <div class="tab-pane" id="medications">
                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <a href="#" class="btn btn-primary">
                                        <i class="fas fa-plus"></i> Добавить медикамент
                                    </a>
                                </div>
                            </div>

                            {% if medications %}
                                <div class="table-responsive">
                                    <table class="table table-bordered table-hover">
                                        <thead>
                                        <tr>
                                            <th>№</th>
                                            <th>Название</th>
                                            <th>Дозировка</th>
                                            <th>Режим приема</th>
                                            <th>Начало</th>
                                            <th>Окончание</th>
                                            <th>Статус</th>
                                            <th>Действия</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        {% for med in medications %}
                                            <tr>
                                                <td>{{ forloop.counter }}</td>
                                                <td>{{ med.medication_name }}</td>
                                                <td>{{ med.dosage }}</td>
                                                <td>{{ med.frequency }}</td>
                                                <td>{{ med.start_date|date:"d.m.Y" }}</td>
                                                <td>{{ med.end_date|date:"d.m.Y" }}</td>
                                                <td>
                                        <span class="badge status-{{ med.state }}">
                                            {{ med.get_state_display }}
                                        </span>
                                                </td>
                                                <td>
                                                    <div class="btn-group btn-group-sm">
                                                        <a href="#" class="btn btn-info">
                                                            <i class="fas fa-eye"></i>
                                                        </a>
                                                        <a href="#" class="btn btn-warning">
                                                            <i class="fas fa-edit"></i>
                                                        </a>
                                                        <a href="#" class="btn btn-danger">
                                                            <i class="fas fa-trash"></i>
                                                        </a>
                                                    </div>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td colspan="8" class="p-0">
                                                    {% now "Y-m-d" as current_date %}
                                                    {% with start=med.start_date|date:"Y-m-d" end=med.end_date|date:"Y-m-d" %}
                                                        {% if med.state == 'assigned' or med.state == 'recommended' %}
                                                            <div class="progress progress-xs m-0"
                                                                 style="height: 5px; border-radius: 0;">
                                                                <div class="progress-bar bg-warning"
                                                                     style="width: {{ med.progress_percent }}%"
                                                                     data-toggle="tooltip"
                                                                     title="День {{ med.days_elapsed }} из {{ med.total_days }} дней курса">
                                                                </div>
                                                            </div>
                                                        {% elif med.state == 'completed' %}
                                                            <div class="progress progress-xs m-0"
                                                                 style="height: 5px; border-radius: 0;">
                                                                <div class="progress-bar bg-success"
                                                                     style="width: 100%"></div>
                                                            </div>
                                                        {% elif med.state == 'cancelled' %}
                                                            <div class="progress progress-xs m-0"
                                                                 style="height: 5px; border-radius: 0;">
                                                                <div class="progress-bar bg-danger"
                                                                     style="width: 100%"></div>
                                                            </div>
                                                        {% elif med.state == 'stopped' %}
                                                            <div class="progress progress-xs m-0"
                                                                 style="height: 5px; border-radius: 0;">
                                                                <div class="progress-bar bg-warning progress-bar-striped"
                                                                     style="width: 100%"></div>
                                                            </div>
                                                        {% endif %}
                                                    {% endwith %}
                                                </td>
                                            </tr>
                                        {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle mr-2"></i>
                                    Нет назначенных медикаментов
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
{% endblock %}
{% block extra_js %}
    <script>
        $(function () {
            // Initialize tooltips
            $('[data-toggle="tooltip"]').tooltip()

            // Handle tab navigation from URL
            var hash = window.location.hash;
            if (hash) {
                $('.nav-pills a[href="' + hash + '"]').tab('show');
            }

            // Update URL when tab changes
            $('.nav-pills a').on('shown.bs.tab', function (e) {
                window.location.hash = e.target.hash;
            });

            // Handle session status changes
            $('.session-status-select').on('change', function () {
                var newStatus = $(this).val();
                var row = $(this).closest('tr');

                // Update row styling based on new status
                row.removeClass('table-success table-danger');
                if (newStatus === 'completed') {
                    row.addClass('table-success');
                } else if (newStatus === 'canceled') {
                    row.addClass('table-danger');
                }
            });

            // Handle individual session save button
            $('.save-session-btn').on('click', function () {
                var sessionId = $(this).data('session-id');
                var form = $(this).closest('form');

                // Show saving indicator
                $(this).html('<i class="fas fa-spinner fa-spin"></i>');

                // Simulate AJAX save (replace with actual AJAX call)
                setTimeout(function () {
                    // Reset button
                    $('.save-session-btn[data-session-id="' + sessionId + '"]')
                        .html('<i class="fas fa-save"></i>')
                        .removeClass('btn-success')
                        .addClass('btn-outline-success');

                    // Show success message
                    $.notify({
                        icon: 'fas fa-check-circle',
                        message: 'Сеанс #' + sessionId + ' успешно обновлен'
                    }, {
                        type: 'success',
                        placement: {
                            from: 'top',
                            align: 'center'
                        },
                        delay: 2000
                    });

                    // After 2 seconds, restore button
                    setTimeout(function () {
                        $('.save-session-btn[data-session-id="' + sessionId + '"]')
                            .removeClass('btn-outline-success')
                            .addClass('btn-success');
                    }, 2000);

                }, 1000);
            });

            // Handle save all sessions button
            $('.save-all-sessions').on('click', function () {
                var procedureId = $(this).data('procedure-id');
                var form = $('#sessionForm' + procedureId);

                // Show saving indicator
                $(this).html('<i class="fas fa-spinner fa-spin mr-1"></i> Сохранение...');

                // Simulate AJAX save (replace with actual AJAX call)
                setTimeout(function () {
                    // Reset button
                    $('.save-all-sessions[data-procedure-id="' + procedureId + '"]')
                        .html('<i class="fas fa-save mr-1"></i> Сохранить все изменения');

                    // Show success message
                    $.notify({
                        icon: 'fas fa-check-circle',
                        message: 'Все сеансы успешно обновлены'
                    }, {
                        type: 'success',
                        placement: {
                            from: 'top',
                            align: 'center'
                        },
                        delay: 2000
                    });

                    // Close modal after 1 second
                    setTimeout(function () {
                        $('#sessionModal' + procedureId).modal('hide');
                    }, 1000);

                }, 1500);
            });
        });
    </script>
{% endblock %}